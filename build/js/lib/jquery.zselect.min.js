/*!
 * Custom select plugin for jQuery (zselect v0.2.0 beta)
 *
 * Author: Maxim Popov <Popov@bluefountainmedia.com>
 *
 * Date: 25/11/2014
 * Depends on library: jQuery 1.9+
 *
 */
(function($, undefined) {
    'use strict';
    var touch_enable = (('ontouchstart' in window) || (navigator.MaxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0)),
        callbacks,
        check_prototype = typeof Prototype !== 'undefined';

    // adaptation for prototype
    if (check_prototype) {
        (function(){
            var eventMatchers = {
                    'HTMLEvents': /^(?:load|unload|abort|error|select|change|submit|reset|focus|blur|resize|scroll)$/,
                    'MouseEvents': /^(?:click|mouse(?:down|up|over|move|out))$/
                },
                defaultOptions = {
                    pointerX: 0,
                    pointerY: 0,
                    button: 0,
                    ctrlKey: false,
                    altKey: false,
                    shiftKey: false,
                    metaKey: false,
                    bubbles: true,
                    cancelable: true
                };

            Event.simulate = function(element, eventName) {
                var options = Object.extend(defaultOptions, arguments[2] || { }),
                    oEvent, eventType = null, name;

                element = window.$(element);

                for (name in eventMatchers) {
                    if (eventMatchers[name].test(eventName)) {
                        eventType = name;
                        break;
                    }
                }

                if (!eventType){
                    throw new SyntaxError('Only HTMLEvents and MouseEvents interfaces are supported');
                }

                if (document.createEvent) {
                    oEvent = document.createEvent(eventType);
                    if (eventType == 'HTMLEvents') {
                        oEvent.initEvent(eventName, options.bubbles, options.cancelable);
                    } else {
                        oEvent.initMouseEvent(eventName, options.bubbles, options.cancelable, document.defaultView,
                            options.button, options.pointerX, options.pointerY, options.pointerX, options.pointerY,
                            options.ctrlKey, options.altKey, options.shiftKey, options.metaKey, options.button, element);
                    }
                    element.dispatchEvent(oEvent);
                } else {
                    options.clientX = options.pointerX;
                    options.clientY = options.pointerY;
                    oEvent = Object.extend(document.createEventObject(), options);
                    element.fireEvent('on' + eventName, oEvent);
                }
                return element;
            };
            Element.addMethods({ simulate: Event.simulate });
        })()
    }

    function Zs(element, options) {
        var $option_placeholder;

        this.$select = $(element);

        this.options = $.extend(true, {}, Zs.defaults, options);

        this.zs_elements = {
            $wrapper    : false,
            $select_text: false,
            $select_btn : false,
            $select     : false,
            $drop       : false,
            $drop_items : false,
            $placeholder: false
        };

        this.current = {
            $drop_item  : false,
            $option     : false
        };
        this.focus_items = {
            $drop_items : false,
            $options    : false,
            $option     : false
        };
        if (this.$select.attr('multiple')) {
            this.multiple = true;
            this.current.$drop_item_point = false;
            this.current.$option_point    = false;
            this.current.$option_focus    = false;
        } else {
            this.multiple = false;
        }

        this.$options            = this.$select.find('option');
        $option_placeholder      = this.$options.filter('[value="' + this.options.placeholder.value + '"]');
        this.$option_placeholder = $option_placeholder.length ? $option_placeholder : false;
        if (this.options.native_menu && !this.multiple) {
            $option_placeholder.data('zs_data', {
                is_placeholder  : true
            });
        }

        this.ready = {
            select  : false,
            drop    : false
        };

        this.is_change_locked = false;

        this.is_open   = false;

        this.in_focus  = false;

        this.is_enable = true;

        this.orig_id   = this.$select.attr('id');

        this.lazy_timer_id = false;

        this.select_id = new Date().getTime() + this.utilities.getRandomInt(0, 500);

        this.plugins = {};
        $.each(Zs.Plugins, $.proxy(function(key, plugin) {
            this.plugins[key[0].toLowerCase() + key.slice(1)]
                = new plugin(this);
        }, this));

        this._addTriggerableEvents();
        this.init();
    }

    // options
    Zs.defaults = {
        width           : true,                                                     // zselect width (true, false, fixed number)
        hide_using_js   : false,                                                    // how to hide zselect (true, false)
        templates: {                                                                // zselect elements templates, don`t use characters before '<' http://stage.jquery.com/upgrade-guide/1.9/#jquery-htmlstring-versus-jquery-selectorstring
            select      : '<div class="zs-text"></div>',                            // select elements, you can also add element (<div class="zs-btn"></div>)
            drop        : '<div class="zs-drop">{{items}}</div>',                   // drop menu
            drop_item   : '<div class="zs-drop-item">{{text}}</div>',               // drop menu item
            origin_first: true                                                      // insert original select as first element in wrapper
        },
        buildSelectText   : false,                                                  // function for build select text
        buildDropItemText : false,                                                  // function for build each drop item from option
        lazy: {
            items : 1000,                                                           // how many in one iteration progressive loading
            time  : 100,                                                            // time between iterations
            text  : 'Loading...'                                                    // text before all drop items load
        },
        placeholder     : {
            value: '',                                                              // Placeholder option value detect
            no_options: 'No items selected'                                         // Placeholder option value detect
        },
        multiple        : {                                                         // multiple options
            height: true,                                                           // height of elements wrapper
            drop  : false                                                           // use multiple with in menu
        },
        native_menu     : false,                                                    // don`t create custom drop menu
        open_top        : true                                                      // turn on open drop down to top
    };

    // callbacks
    callbacks = {
        initBefore: false,      // before initialization
        initAfter : false,      // after initialization
        dropItemBefore: false,  // before drop item build
        dropItemAfter : false,  // after drop item build
        buildAfter: false,      // after build DOM of zselect
        openAfter : false,      // after drop menu open
        closeAfter: false,      // after drop menu close
        disableItemAfter: false,// after disable Item
        enableItemAfter : false,// after enable Item
        setItemAfter  : false   // after set Item
    };

    Zs.Plugins = {};

    Zs.prototype.zs = '0.2.0';

    Zs.prototype.utilities = {
        $window     : $(window),
        $document   : $(document),
        touch_enable: touch_enable,
        keyCode: {
            BACKSPACE: 8,
            COMMA: 188,
            DELETE: 46,
            DOWN: 40,
            END: 35,
            ENTER: 13,
            ESCAPE: 27,
            HOME: 36,
            LEFT: 37,
            PAGE_DOWN: 34,
            PAGE_UP: 33,
            PERIOD: 190,
            RIGHT: 39,
            SPACE: 32,
            TAB: 9,
            UP: 38
        },
        getRandomInt: function(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    };

    Zs.prototype.init = function() {
        this.trigger('initBefore');

        // build zselect DOM
        this._buildDom();

        // add events
        this._eventsInit();

        // hide select
        if (this.options.hide_using_js &&
            !this.options.native_menu) {
            this.$select.hide();
        }

        if (this.$select.attr('disabled')) {
            this.trigger('disable');
        }
        this.trigger('initAfter');
    };

    Zs.prototype._buildDom = function() {
        this._buildDomWrapper();
        if ((this.options.native_menu && !this.multiple) ||
            (this.options.native_menu && this.multiple &&
                this.options.multiple.drop && this.utilities.touch_enable)) {

        } else {
            this._buildDomDrop();
        }
        if (!this.multiple || (this.multiple && this.options.multiple.drop)) {
            this._buildDomSelect();
        }
        this.trigger('buildAfter');
    };

    Zs.prototype._buildDomWrapper = function() {
        var $wrapper      = $('<div class="zs"></div>'),
            my_name       = this.$select.attr('name'),
            orig_classes  = this.$select.attr('class'),
            tabindex      = this.$select.attr('tabindex'),
            select_styles = this.$select.attr('style'),
            class_arr;

        this.zs_elements.$wrapper = $wrapper;

        // set select attributes
        if (this.orig_id) {
            $wrapper.attr('id', this.orig_id + '-zs');
        }
        if (my_name) {
            $wrapper.attr('data-name', my_name);
        }
        if (orig_classes) {
            class_arr = $.trim(orig_classes).split(' ');
            $.each(class_arr, function(id) {
                class_arr[id] += '-zs';
            });
            $wrapper.addClass(class_arr.join(' '));
        }
        if (select_styles) {
            $wrapper.attr('style', select_styles);
        }
        if (tabindex) {
            $wrapper.attr('tabindex', tabindex);
        } else {
            $wrapper.attr('tabindex', 0);
        }
        this.$select.attr({
            tabindex: -1
        });

        // set select width
        if (this.options.width !== false) {
            $wrapper.width(
                (this.options.width === true) ?
                    this.$select.outerWidth(true) :
                    this.options.width
            );
        }

        if ((this.options.native_menu && !this.multiple) ||
            (this.options.native_menu && this.multiple &&
                this.options.multiple.drop && this.utilities.touch_enable)) {
            $wrapper.addClass('zs-native-menu');
        }

        if (this.multiple) {
            $wrapper.addClass('zs-multiple');
        }

        if (this.options.multiple.drop) {
            $wrapper.addClass('zs-multiple-drop');
        }

        if (this.utilities.touch_enable) {
            $wrapper.addClass('zs-touch');
        }

        // insert wrapper
        $wrapper.insertAfter(this.$select)
            .append(this.$select);
    };

    Zs.prototype._buildDomSelect = function() {
        var template = (typeof this.options.templates.select === 'function') ?
                this.options.templates.select(this.$select) :
                this.options.templates.select,
            $select  = $('<div></div>').append(template),
            $zs_text= $select.find('.zs-text'),
            $zs_btn = $select.find('.zs-btn');

        if ($zs_text.length) {
            this.zs_elements.$select_text = $zs_text;
        }
        if ($zs_btn.length) {
            this.zs_elements.$select_btn  = $zs_btn;
        }

        if (!this.options.native_menu && this.ready.drop) {
            this.trigger('setItem');
        }
        if (this.options.native_menu) {
            this.trigger('setItem');
        }
        if (!this.options.native_menu &&
            !this.ready.drop &&
            this.zs_elements.$select_text) {
            this.zs_elements.$select_text.text(this.options.lazy.text);
        }

        this.ready.select = true;

        if (this.options.templates.origin_first) {
            this.zs_elements.$select = $select.insertAfter(this.$select);
        } else {
            this.zs_elements.$select = $select.prependTo(this.zs_elements.$wrapper);
        }
        this.zs_elements.$select
            .contents()
            .unwrap();
    };

    Zs.prototype._buildDomDrop = function() {
        var drop_html = (typeof this.options.templates.drop === 'function') ?
                this.options.templates.drop(this.$select) : this.options.templates.drop,
            tmp_id    = 'tmp' + new Date().getTime() + '-' + this.utilities.getRandomInt(0, 1000),
            $drop_wr  = $('<div></div>').append(
                drop_html.replace('{{items}}', '<span id="' + tmp_id + '"></span>')
            ),
            $tmp_drop_inner = $drop_wr.find('#' + tmp_id);

        this._buildDropItemsAll($tmp_drop_inner);

        this.zs_elements.$drop = $drop_wr.find('.zs-drop');

        if (this.multiple && !this.options.multiple.drop) {
            this.zs_elements.$drop.attr({
                tabindex: -1
            });
        }

        if (this.options.templates.origin_first) {
            $drop_wr.insertAfter(this.$select)
        } else {
            $drop_wr.insertBefore(this.$select)
        }
        $drop_wr
            .contents()
            .unwrap();

        if (this.multiple) {
            if (this.options.multiple.height === true &&
                !$.isNumeric(this.options.multiple.height)) {
                this.zs_elements.$drop.height(this.$select.outerHeight());
            }
            if (this.options.multiple.height !== true &&
                $.isNumeric(this.options.multiple.height)) {
                this.zs_elements.$drop.height(this.options.multiple.height);
            }
        }
        $tmp_drop_inner.remove();
    };

    Zs.prototype._buildDomDropItem = function($option) {
        this.trigger('dropItemBefore', $option);

        var text    = $option.text(),
            $result = $(this.options.templates.drop_item.replace(
                '{{text}}',
                typeof this.options.buildDropItemText === 'function' ?
                    this.options.buildDropItemText($option) :
                    text
            )),
            value   = $option.attr('value'),
            my_id   = $option.attr('id'),
            title      = $option.attr('title'),
            selected   = $option.attr('selected'),
            disabled   = $option.attr('disabled'),
            orig_class = $option.attr('class'),
            attributes = {},
            classes    = [],
            $my_dropitem;

        if (value) {
            attributes['data-value'] = value;
        }
        if (my_id) {
            attributes['id'] = my_id + '-zs-drop-item';
        }
        if (title) {
            attributes['title'] = title;
        }
        if (selected) {
            classes.push('zs-active');
        }
        if (orig_class) {
            classes.push(orig_class);
        }

        $my_dropitem = $('<div></div>').append($result)
            .find('.zs-drop-item')
            .attr(attributes)
            .addClass(classes.join(' '));

        if (disabled) {
            $my_dropitem
                .data('zs_data', {
                    enable: false
                });
            $option.data('zs_data', {
                enable: false
            });
        } else {
            $my_dropitem
                .data('zs_data', {
                    enable: true
                });
            $option.data('zs_data', {
                enable: true
            });
        }

        this.trigger('dropItemAfter', $option, $result);
        return $result;
    };

    Zs.prototype.addItem = function(ev, option, data) {

    };

    Zs.prototype._buildDropItemsAll = function($hook) {
        var that        = this,
            $hook_item  = $hook,
            $temp_optgroup      = false,
            $temp_dropoptgroup  = false,
            $temp_optgroup_data = {},
            item_count_now   = 0,   // counter increase by each item
            item_count_group = 1;   // counter increase by option -> lazy.items

        that.zs_elements.$drop_items = $();

        function lazyLoad() {
            that.$options.filter(function(id) {
                return id >= item_count_now;
            })
                .each(function() {
                    // check if lots of options
                    item_count_now += 1;
                    if (item_count_now > that.options.lazy.items * item_count_group) {
                        item_count_group += 1;
                        item_count_now   -= 1;
                        that.lazy_timer_id = setTimeout(function() {
                            if (that.lazy_timer_id !== false) {
                                clearTimeout(that.lazy_timer_id);
                                that.lazy_timer_id = false;
                            }
                            lazyLoad();
                        }, that.options.lazy.time);
                        return false;
                    }

                    // build item
                    var $self  = $(this),
                        value  = $self.attr('value'),
                        is_placeholder = false,
                        $my_optgroup = $self.closest('optgroup'),
                        $result_item, $temp_el, $temp_wrap, $drop_item,
                        option_data, option_data_old, dropitem_data, dropitem_data_old;

                    if (typeof that.options.templates.drop_item === 'function') {
                        $result_item = that.options.templates.drop_item($self[0]);
                    } else {
                        $result_item = that._buildDomDropItem($self);
                    }

                    $temp_wrap = $('<div></div>');
                    $drop_item = $temp_wrap.append($result_item)
                        .find('.zs-drop-item');

                    if ($result_item && typeof $result_item.insertAfter === 'function') {
                        $temp_wrap.insertAfter($hook_item);
                    }

                    // check for placeholder
                    if (value !== undefined && value === that.options.placeholder.value) {
                        if (that.zs_elements.$placeholder) {
                            that.zs_elements.$placeholder = that.zs_elements.$placeholder.add($drop_item);
                        } else {
                            that.zs_elements.$placeholder = $drop_item;
                        }
                        $drop_item.addClass('zs-drop-placeholder');
                        is_placeholder = true;
                    }

                    // set data && optgroup
                    option_data = {
                        $drop_item      : $drop_item,
                        $option_element : $result_item,
                        is_placeholder  : is_placeholder,
                        enable          : true
                    };
                    option_data_old = $self.data('zs_data') || {};
                    dropitem_data = {
                        $option         : $self,
                        $option_element : $result_item,
                        is_placeholder  : is_placeholder,
                        enable          : true
                    };
                    dropitem_data_old = $drop_item.data('zs_data') || {};

                    if ($my_optgroup.length) {
                        if (!$temp_optgroup || $my_optgroup[0] !== $temp_optgroup[0]) {
                            $temp_optgroup = $my_optgroup;
                            $temp_optgroup_data.label    = $temp_optgroup.attr('label') || '';
                            $temp_optgroup_data.disabled = $temp_optgroup.attr('disabled') || false;
                            $temp_optgroup_data.classes  = $temp_optgroup.attr('class') || '';
                            if ($temp_optgroup_data.disabled) {
                                $temp_optgroup_data.classes += ' zs-drop-disabled';
                            }
                            $temp_dropoptgroup = $('<div class="zs-drop-optgroup">' + $temp_optgroup_data.label + '</div>')
                                .insertBefore($temp_wrap)
                                .attr('data-label', $temp_optgroup_data.label)
                                .addClass($temp_optgroup_data.classes);
                        }
                        dropitem_data.$drop_optgroup = $temp_dropoptgroup;
                        option_data.$optgroup        = $temp_optgroup;
                        if ($temp_optgroup_data.disabled) {
                            option_data_old.enable = false;
                        }
                        $drop_item.addClass('zs-drop-inoptgroup');
                    }
                    if (option_data_old) {
                        $self.data('zs_data', $.extend(option_data, option_data_old));
                    } else {
                        $self.data('zs_data', option_data);
                    }
                    if (dropitem_data_old) {
                        $drop_item.data('zs_data', $.extend(dropitem_data, dropitem_data_old));
                    } else {
                        $drop_item.data('zs_data', dropitem_data);
                    }

                    // disable
                    if (option_data_old && !option_data_old.enable) {
                        that.trigger('disableItem', $self);
                    }

                    // init drop item events
                    that._eventsDropItem($drop_item, $self);

                    $temp_el = that.zs_elements.$drop_items;
                    that.zs_elements.$drop_items = $temp_el.add($drop_item);

                    if ($hook_item[0] !== $hook[0]) {
                        $hook_item.contents().unwrap();
                    }
                    $hook_item = $temp_wrap;

                    if (!this.multiple &&
                        item_count_now === that.$options.length) {
                        that.ready.drop = true;
                    }
                    if (item_count_now === that.$options.length) {
                        $hook_item.contents().unwrap();
                    }
                    if (item_count_now === that.$options.length &&
                        (that.ready.select || that.multiple)) {
                        that.trigger('setItem');
                    }
                });
        }

        lazyLoad();
    };

    Zs.prototype.disableItem = function(ev, zs, option) {
        if (!option) {
            return;
        }
        var $options = this.$options
            .filter(option)
            .each(function() {
                var $self = $(this),
                    my_data = $self.data('zs_data'),
                    drop_data;

                if (my_data) {
                    my_data.enable = false;
                    $self
                        .attr('disabled', true)
                        .data('zs_data', my_data);
                    drop_data = my_data.$drop_item.data('zs_data');
                    drop_data.enable = false;
                    my_data.$drop_item
                        .addClass('zs-drop-disabled')
                        .data('zs_data', drop_data);
                }
            });

        this.trigger('disableItemAfter', $options);
    };

    Zs.prototype.enableItem = function(ev, zs, option) {
        if (!option) {
            return;
        }
        var $options = this.$options
            .filter(option)
            .each(function() {
                var $self = $(this),
                    my_data = $self.data('zs_data'),
                    drop_data;

                if (my_data) {
                    my_data.enable = true;
                    $self
                        .removeAttr('disabled', true)
                        .data('zs_data', my_data);
                    drop_data = my_data.$drop_item.data('zs_data');
                    drop_data.enable = true;
                    my_data.$drop_item
                        .removeClass('zs-drop-disabled')
                        .data('zs_data', drop_data);
                }
            });


        this.trigger('enableItemAfter', $options);
    };

    // add triggerable events
    Zs.prototype._addTriggerableEvents = function() {
        var that = this;

        this._triggerableEvents = {
            addItem : this.addItem,
            setItem : this.setItem,
            setPrev : this.setPrev,
            setNext : this.setNext,
            disableItem : this.disableItem,
            enableItem  : this.enableItem,
            open    : this.open,
            close   : this.close,
            refresh : this.refresh,
            enable  : this.enable,
            disable : this.disable,
            destroy : this.destroy
        };

        $.each(this._triggerableEvents, $.proxy(function(event, callback) {
            var event_opt = 'on' + (event[0].toUpperCase() + event.slice(1));

            //this.$select.on(event + '.zselect', $.proxy(callback, this));
            this.$select.on(event + '.zselect', function() {
                var my_arguments = $.makeArray(arguments);
                if (my_arguments[1] && !my_arguments[1].zs) {
                    my_arguments.splice(1, 0, that);
                }
                if (my_arguments.length === 1) {
                    my_arguments.push(that);
                }
                if (typeof that.options[event_opt] === 'function') {
                    that.options[event_opt].apply(that, my_arguments);
                }
                $.proxy(callback, that).apply(that, my_arguments);
            });
        }, this));
    };

    // trigger events
    Zs.prototype.trigger = function(ev) {
        if (!ev) {
            return;
        }
        var event_opt    = 'on' + (ev[0].toUpperCase() + ev.slice(1)),
            my_arguments = [].slice.call(arguments, 1);

        my_arguments.unshift(this);

        this.$select.trigger(ev + '.zselect', my_arguments);

        if (!this._triggerableEvents[ev] && typeof this.options[event_opt] === 'function') {
            my_arguments.unshift(
                $.Event(ev + '.zselect', {
                    relatedTarget: this,
                    currentTarget: this.$select
                })
            );
            this.options[event_opt].apply(this.$select, my_arguments);
        }
    };

    Zs.prototype._eventsInit = function() {
        var that       = this,
            doc_events = {};

        // add service functions to the standard events of select
        $.each({
            'change.zselect': function(e, $option, set_data) {
                if (!that.is_change_locked) {
                    that.trigger('setItem');
                }
            }
        }, $.proxy(function(event, callback) {
            this.$select.on(event, $.proxy(callback, this));
        }, this));

        // init zselect wrapper events
        this._eventsWrapper();

        // init zselect buttons events
        if ((this.zs_elements.$select_text && this.zs_elements.$select_text.length)
            || (this.zs_elements.$select_btn && this.zs_elements.$select_btn.length)) {
            this._eventsBtnsInit();
        }

        // document events
        if (!this.multiple || (this.multiple && this.options.multiple.drop)) {
            if (this.utilities.touch_enable && $.Finger) {
                doc_events['tap.zselect' + this.select_id] = function(e) {
                    if (!that.is_open) {
                        return;
                    }
                    if (!$(e.target).closest(that.zs_elements.$wrapper).length) {
                        that.trigger('close');
                    }
                };
            } else {
                doc_events['mousedown.zselect' + this.select_id] = function(e) {
                    if (!that.is_open) {
                        return;
                    }
                    if (!$(e.target).closest(that.zs_elements.$wrapper).length) {
                        that.trigger('close');
                    }
                };
            }
            this.utilities.$document.on(doc_events);
        }
    };

    Zs.prototype._eventsFilterItems = function(character) {
        var escapedCharacter = character.replace( /[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&" ),
            regex = new RegExp( "^" + escapedCharacter, "i" );

        return this.$options.filter(function() {
            return regex.test(
                $.trim($(this).text())
            );
        });
    };

    Zs.prototype._eventsWrapper = function() {
        var that = this,
            wrapper_events = {
                focusin: function() {
                    if (!that.in_focus) {
                        that.zs_elements.$wrapper.addClass('zs-focus');
                        that.zs_elements.$wrapper.parent().addClass('zs-focus');
                        that.in_focus = true;
                    }
                },
                blur: function() {
                    if (that.in_focus) {
                        that.zs_elements.$wrapper.removeClass('zs-focus');
                        that.zs_elements.$wrapper.parent().removeClass('zs-focus');
                        that.in_focus = false;
                    }
                    if (that.is_open &&
                        (!that.multiple || (that.multiple && that.options.multiple.drop))) {
                        that.trigger('close');
                    }
                }
            },
            focus_prev, focus_skip, focus_prev_filter, focus_match,
            focus_filter_timer, character, cur_index;

        function hotTyping(e) {
            focus_prev = focus_prev_filter || "";
            character = String.fromCharCode(e.keyCode);
            focus_skip = false;

            clearTimeout(focus_filter_timer);

            if (character === focus_prev) {
                focus_skip = true;
            } else {
                character = focus_prev + character;
            }

            cur_index = that.$options.index(that.current.$option);
            focus_match = that._eventsFilterItems(character);
            focus_match = focus_skip &&
                that.current.$option &&
                focus_match.index(
                    that.$options.eq(cur_index + 1)
                ) !== -1 ?
                that.$options.filter(function(id) {
                    return id > cur_index;
                }) : focus_match;

            // If no matches on the current filter, reset to the last character pressed
            // to move down the menu to the first item that starts with that character
            if (!focus_match.length) {
                character   = String.fromCharCode(e.keyCode);
                focus_match = that._eventsFilterItems(character);
            }

            if (focus_match.length) {
                that._focusItem(focus_match);
                focus_prev_filter = character;
                focus_filter_timer = setTimeout(function() {
                    focus_prev_filter = false;
                }, 1000);
            } else {
                focus_prev_filter = false;
            }
        }

        if (this.utilities.touch_enable && $.Finger) {

        } else {
            if (that.multiple) {
                wrapper_events.keydown = function(e) {
                    var prevent_default = true,
                        $new_option, focus_index, point_index, first_index, last_index,
                        new_option_data, tmp_i, $tmp_option, tmp_data, tmp_max;

                    if (!that.is_enable) {
                        return;
                    }

                    switch (e.keyCode) {
                        case that.utilities.keyCode.ENTER:
                            if (/*!that.options.native_menu && */that.is_open && that.options.multiple.drop) {
                                that.trigger('close');
                            }
                            prevent_default = false;
                            break;
                        case that.utilities.keyCode.ESCAPE:
                            if (/*!that.options.native_menu && */!that.is_open && that.options.multiple.drop) {
                                that.trigger('close');
                            }
                            prevent_default = false;
                            break;
                        case that.utilities.keyCode.LEFT:
                        case that.utilities.keyCode.UP:
                            if (e.altKey) {
                                if (/*!that.options.native_menu && */that.is_open &&
                                    that.options.multiple.drop && e.keyCode !== that.utilities.keyCode.LEFT) {
                                    that.trigger('close');
                                }
                            } else {
                                if (that.current.$option === false) {
                                    $new_option     = that.$options.eq(0);
                                    new_option_data = $new_option.data('zs_data');
                                    if (new_option_data && new_option_data.enable) {
                                        that.current.$option_focus = $new_option;
                                        that.trigger('setItem', $new_option);
                                    }
                                } else {
                                    focus_index = that.$options.index(that.current.$option_focus);
                                    point_index = that.$options.index(that.current.$option_point);
                                    if (e.shiftKey && !e.ctrlKey) {
                                        if (focus_index <= point_index && focus_index !== 0) {
                                            that.trigger(
                                                'setItem',
                                                that.$options.filter(function(id) {
                                                    var $self = $(this),
                                                        my_data = $self.data('zs_data');
                                                    return id >= focus_index - 1 && id <= point_index &&
                                                        my_data && my_data.enable;
                                                }),
                                                { multi_shift: true }
                                            );
                                        }
                                        if (focus_index > point_index) {
                                            that.trigger(
                                                'setItem',
                                                that.$options.filter(function(id) {
                                                    var $self = $(this),
                                                        my_data = $self.data('zs_data');

                                                    return id >= point_index && id <= focus_index - 1 &&
                                                        my_data && my_data.enable;
                                                }),
                                                { multi_shift: true }
                                            );
                                        }
                                    }
                                    if (e.shiftKey && e.ctrlKey) {
                                        first_index = that.$options.index(that.current.$option.eq(0));
                                        if (focus_index <= first_index && focus_index !== 0) {
                                            last_index = that.$options.index(that.current.$option.eq(-1));
                                            that.trigger(
                                                'setItem',
                                                that.$options.filter(function(id) {
                                                    var $self = $(this),
                                                        my_data = $self.data('zs_data');

                                                    return id >= focus_index - 1 && id <= last_index &&
                                                        my_data && my_data.enable;
                                                })
                                            );
                                        }
                                    }
                                    if (focus_index !== 0 &&
                                        ((!e.shiftKey && !e.ctrlKey) || (!e.shiftKey && e.ctrlKey))) {
                                        that.trigger('setPrev');
                                    } else {
                                        if (focus_index !== 0) {
                                            that.current.$option_focus = that.$options.eq(focus_index - 1);
                                        }
                                    }
                                }
                            }
                            break;
                        case that.utilities.keyCode.RIGHT:
                        case that.utilities.keyCode.DOWN:
                            if (e.altKey) {
                                if (/*!that.options.native_menu && */!that.is_open &&
                                    that.options.multiple.drop && e.keyCode !== that.utilities.keyCode.RIGHT) {
                                    that.trigger('open');
                                }
                            } else {
                                if (that.current.$option === false) {
                                    $new_option                = that.$options.eq(0);
                                    new_option_data = $new_option.data('zs_data');
                                    if (new_option_data && new_option_data.enable) {
                                        that.current.$option_focus = $new_option;
                                        that.trigger('setItem', $new_option);
                                    }
                                } else {
                                    focus_index = that.$options.index(that.current.$option_focus);
                                    point_index = that.$options.index(that.current.$option_point);
                                    if (e.shiftKey && !e.ctrlKey) {
                                        if (focus_index >= point_index && focus_index !== that.$options.length - 1) {
                                            that.trigger(
                                                'setItem',
                                                that.$options.filter(function(id) {
                                                    var $self = $(this),
                                                        my_data = $self.data('zs_data');
                                                    return id >= point_index && id <= focus_index + 1 &&
                                                        my_data && my_data.enable;
                                                }),
                                                { multi_shift: true }
                                            );
                                        }
                                        if (focus_index < point_index) {
                                            that.trigger(
                                                'setItem',
                                                that.$options.filter(function(id) {
                                                    var $self = $(this),
                                                        my_data = $self.data('zs_data');
                                                    return id >= focus_index + 1 && id <= point_index &&
                                                        my_data && my_data.enable;
                                                }),
                                                { multi_shift: true }
                                            );
                                        }
                                    }
                                    if (e.shiftKey && e.ctrlKey) {
                                        last_index = that.$options.index(that.current.$option.eq(-1));
                                        if (focus_index >= last_index && focus_index !== that.$options.length - 1) {
                                            first_index = that.$options.index(that.current.$option.eq(0));
                                            that.trigger(
                                                'setItem',
                                                that.$options.filter(function(id) {
                                                    var $self = $(this),
                                                        my_data = $self.data('zs_data');
                                                    return id >= first_index && id <= focus_index + 1 &&
                                                        my_data && my_data.enable;
                                                })
                                            );
                                        }
                                    }
                                    if (focus_index !== that.$options.length - 1 &&
                                        ((!e.shiftKey && !e.ctrlKey) || (!e.shiftKey && e.ctrlKey))) {
                                        that.trigger('setNext');
                                    } else {
                                        if (focus_index !== that.$options.length - 1) {
                                            that.current.$option_focus = that.$options.eq(focus_index + 1);
                                        }
                                    }
                                }
                            }
                            break;
                        case that.utilities.keyCode.HOME:
                        case that.utilities.keyCode.PAGE_UP:
                            for (tmp_i = 0; tmp_i < that.$options.length - 1; tmp_i++) {
                                $tmp_option = that.$options.eq(tmp_i);
                                tmp_data    = $tmp_option.data('zs_data');
                                if (tmp_data && tmp_data.enable) {
                                    that.trigger('setItem', $tmp_option);
                                    that.current.$option_focus = $tmp_option;
                                    break;
                                }
                            }
                            break;
                        case that.utilities.keyCode.END:
                        case that.utilities.keyCode.PAGE_DOWN:
                            for (tmp_max = that.$options.length; tmp_max--;) {
                                $tmp_option = that.$options.eq(tmp_max);
                                tmp_data = $tmp_option.data('zs_data');
                                if (tmp_data && tmp_data.enable) {
                                    that.trigger('setItem', $tmp_option);
                                    that.current.$option_focus = $tmp_option;
                                    break;
                                }
                            }
                            break;
                        default :
                            prevent_default = false;
                            if (!that.options.native_menu &&
                                (!that.options.multiple.drop ||
                                    (that.options.multiple.drop && that.is_open))) {
                                hotTyping(e);
                            }
                    }

                    if (prevent_default) {
                        e.preventDefault();
                    }
                };
            } else {
                wrapper_events.keydown = function(e) {
                    var prevent_default = true,
                        tmp_i, $tmp_option, tmp_data, tmp_max;

                    if (!that.is_enable) {
                        return;
                    }
                    switch (e.keyCode) {
                        case that.utilities.keyCode.ENTER:
                            if (!that.options.native_menu && that.is_open) {
                                if (that.focus_items.$options) {
                                    that.trigger('setItem', that.focus_items.$options.eq(0));
                                }
                                that.trigger('close');
                            }
                            prevent_default = false;
                            break;
                        case that.utilities.keyCode.ESCAPE:
                            if (!that.options.native_menu) {
                                that.trigger('close');
                            }
                            prevent_default = false;
                            break;
                        case that.utilities.keyCode.UP:
                            if (e.altKey) {
                                if (!that.options.native_menu && that.is_open) {
                                    that.trigger('close');
                                }
                            } else {
                                if (that.focus_items.$options) {
                                    that.trigger('setItem', that.focus_items.$option);
                                    that._blurFocusItem();
                                }
                                that.trigger('setPrev');
                            }
                            break;
                        case that.utilities.keyCode.DOWN:
                            if (e.altKey) {
                                if (!that.options.native_menu && !that.is_open) {
                                    that.trigger('open');
                                }
                            } else {
                                if (that.focus_items.$options) {
                                    that.trigger('setItem', that.focus_items.$option);
                                    that._blurFocusItem();
                                }
                                that.trigger('setNext');
                            }
                            break;
                        case that.utilities.keyCode.LEFT:
                            that.trigger('setPrev');
                            break;
                        case that.utilities.keyCode.RIGHT:
                            that.trigger('setNext');
                            break;
                        case that.utilities.keyCode.HOME:
                        case that.utilities.keyCode.PAGE_UP:
                            for (tmp_i = 0; tmp_i < that.$options.length - 1; tmp_i++) {
                                $tmp_option = that.$options.eq(tmp_i);
                                tmp_data    = $tmp_option.data('zs_data');
                                if (tmp_data && tmp_data.enable) {
                                    that.trigger('setItem', $tmp_option);
                                    break;
                                }
                            }
                            break;
                        case that.utilities.keyCode.END:
                        case that.utilities.keyCode.PAGE_DOWN:
                            for (tmp_max = that.$options.length; tmp_max--;) {
                                $tmp_option = that.$options.eq(tmp_max);
                                tmp_data = $tmp_option.data('zs_data');
                                if (tmp_data && tmp_data.enable) {
                                    that.trigger('setItem', $tmp_option);
                                    break;
                                }
                            }
                            break;
                        default :
                            prevent_default = false;
                            if (that.is_open) {
                                hotTyping(e);
                            }
                    }

                    if (prevent_default) {
                        e.preventDefault();
                    }
                };
            }
        }

        this.zs_elements.$wrapper.on(wrapper_events);
    };

    Zs.prototype._eventsBtnsInit = function() {
        var that        = this,
            btns_events = {},
            timeout_id  = false;

        if (this.utilities.touch_enable && $.Finger) {
            btns_events['tap.zselect'] = function() {
                if (!that.is_enable) {
                    return;
                }
                if (timeout_id) {
                    clearTimeout(timeout_id);
                    timeout_id = false;
                }
                timeout_id = setTimeout(function() {
                    if (that.is_open) {
                        that.trigger('close');
                    } else {
                        that.trigger('open');
                    }
                }, 30);
            };
        } else {
            btns_events.mousedown = function() {
                if (!that.is_enable) {
                    return;
                }
                if (that.is_open) {
                    that.trigger('close');
                } else {
                    that.trigger('open');
                }
            };
        }

        if (this.zs_elements.$select_text &&
            this.zs_elements.$select_text.length) {
            this.zs_elements.$select_text.on(btns_events);
        }
        if (this.zs_elements.$select_btn &&
            this.zs_elements.$select_btn.length) {
            this.zs_elements.$select_btn.on(btns_events);
        }
    };

    Zs.prototype._eventsDropItem = function($drop_item, $option) {
        var that   = this,
            events = {};

        function eventSetDropItemSingle() {
            var drop_data = $option.data('zs_data');
            if (!that.is_enable || !drop_data || !drop_data.enable) {
                return;
            }
            that.trigger('setItem', $option);
            that.trigger('close');
        }

        if (this.multiple) {
            if (this.utilities.touch_enable && $.Finger) {
                events['tap.zselect'] = function() {
                    var drop_data = $option.data('zs_data'),
                        my_index;

                    if (!that.is_enable || !drop_data || !drop_data.enable) {
                        return;
                    }

                    if (that.current.$option) {
                        if (that.current.$option.index($option) === -1) {
                            that.trigger('setItem', that.current.$option.add($option));
                            that.current.$drop_item_point = $drop_item;
                            that.current.$option_point    = $option;
                        } else {
                            my_index = that.current.$option.index($option);

                            if (that.current.$option.length === 1) {
                                $option.removeAttr('selected').prop('selected', false);
                                that.trigger('setItem');
                                that.current.$option    = false;
                                that.current.$drop_item = false;
                            } else {
                                that.trigger('setItem', that.current.$option.filter(function(id) {
                                    var $self = $(this),
                                        my_data = $self.data('zs_data');
                                    return id !== my_index &&
                                        my_data && my_data.enable;
                                }));
                            }
                        }
                        return;
                    }

                    that.trigger('setItem', $option);
                };
            } else {
                events.mouseup = function(e) {
                    var drop_data = $option.data('zs_data'),
                        my_index, item_point_index,
                        cur_first_index, cur_last_index;

                    if (!that.is_enable || !drop_data || !drop_data.enable) {
                        return;
                    }

                    that.current.$option_focus = $option;

                    if (e.ctrlKey && !e.shiftKey && that.current.$option !== false) {
                        if (that.current.$option.index($option) === -1) {
                            that.trigger('setItem', that.current.$option.add($option));
                            that.current.$drop_item_point = $drop_item;
                            that.current.$option_point    = $option;
                        } else {
                            my_index = that.current.$option.index($option);

                            if (that.current.$option.length === 1) {
                                $option.removeAttr('selected').prop('selected', false);
                                that.trigger('setItem');
                                that.current.$option    = false;
                                that.current.$drop_item = false;
                            } else {
                                that.trigger('setItem', that.current.$option.filter(function(id) {
                                    var $self = $(this),
                                        my_data = $self.data('zs_data');
                                    return id !== my_index &&
                                        my_data && my_data.enable;
                                }));
                            }
                        }
                        return;
                    }
                    if (e.shiftKey && !e.ctrlKey && that.current.$option !== false) {
                        if (that.current.$drop_item_point === false) {
                            that.trigger('setItem', $option);
                        } else {
                            my_index           = that.$options.index($option);
                            item_point_index   = that.$options.index(that.current.$option_point);

                            if (my_index < item_point_index) {
                                that.trigger(
                                    'setItem',
                                    that.$options.filter(function(id) {
                                        var $self = $(this),
                                            my_data = $self.data('zs_data');
                                        return id >= my_index && id <= item_point_index &&
                                            my_data && my_data.enable;
                                    }),
                                    { multi_shift: true }
                                );
                            }
                            if (my_index > item_point_index) {
                                that.trigger(
                                    'setItem',
                                    that.$options.filter(function(id) {
                                        var $self = $(this),
                                            my_data = $self.data('zs_data');
                                        return id >= item_point_index && id <= my_index &&
                                            my_data && my_data.enable;
                                    }),
                                    { multi_shift: true }
                                );
                            }
                            if (my_index === item_point_index) {
                                that.trigger(
                                    'setItem',
                                    $option,
                                    { multi_shift: true }
                                );
                            }
                        }
                        return;
                    }
                    if (e.shiftKey && e.ctrlKey && that.current.$option !== false) {
                        my_index = that.$options.index($option);
                        cur_first_index = that.$options.index(that.current.$option.eq(0));
                        cur_last_index  = that.$options.index(that.current.$option.eq(-1));

                        if (my_index >= cur_first_index && my_index <= cur_last_index) {
                            that.trigger(
                                'setItem',
                                that.$options.filter(function(id) {
                                    var $self = $(this),
                                        my_data = $self.data('zs_data');
                                    return id >= cur_first_index && id <= cur_last_index &&
                                        my_data && my_data.enable;
                                })
                            );
                        }
                        if (my_index < cur_first_index) {
                            that.trigger(
                                'setItem',
                                that.$options.filter(function(id) {
                                    var $self = $(this),
                                        my_data = $self.data('zs_data');
                                    return id >= my_index && id <= cur_last_index &&
                                        my_data && my_data.enable;
                                })
                            );
                        }
                        if (my_index > cur_last_index) {
                            that.trigger(
                                'setItem',
                                that.$options.filter(function(id) {
                                    var $self = $(this),
                                        my_data = $self.data('zs_data');
                                    return id >= cur_first_index && id <= my_index &&
                                        my_data && my_data.enable;
                                })
                            );
                        }
                        return;
                    }

                    that.trigger('setItem', $option);
                    that.current.$drop_item_point = $drop_item;
                    that.current.$option_point    = $option;
                };
            }
        } else {
            if (this.utilities.touch_enable) {
                if ($.Finger) {
                    events['tap.zselect'] = eventSetDropItemSingle;
                } else {
                    events.click = eventSetDropItemSingle;
                }
            } else {
                events.mouseup = eventSetDropItemSingle;
            }
        }

        $drop_item.on(events);
    };

    Zs.prototype._getSelectText = function($option) {
        var text = '';

        if (typeof this.options.buildSelectText === 'function') {
            text = this.options.buildSelectText($option);
        } else {
            if (this.multiple &&
                this.zs_elements.$select_text && this.zs_elements.$select_text.length) {
                if ($option.length === 1) {
                    text = $option.text();
                }
                if ($option.length > 1) {
                    text = $option.length + ' Items';
                }
                if ($option.length === 0) {
                    text = this.options.placeholder.no_options;
                }
            } else {
                text = $option.eq(0).text();
            }
        }

        return text;
    };

    Zs.prototype._focusItem = function($options) {
        var that = this,
            $drop_focus;
        if (this.focus_items.$options) {
            this.focus_items.$drop_items.removeClass('zs-item-focus');
        }

        $options.each(function(id) {
            var $option = $(this),
                zs_data = $option.data('zs_data'),
                $drop_item = zs_data.$drop_item;

            if (id === 0) {
                that.focus_items.$drop_items = $drop_item;
                if (zs_data.enable) {
                    $drop_focus = $drop_item;
                    that._selectFocusDropItem($drop_item, $option);
                }
            } else {
                that.focus_items.$drop_items = that.focus_items.$drop_items.add($drop_item);
                if (!$drop_focus) {
                    $drop_focus = $drop_item;
                    that._selectFocusDropItem($drop_item, $option);
                }
            }
        });
        this.focus_items.$options = $options.eq(0);

    };

    Zs.prototype._selectFocusDropItem = function($drop_item, $option) {
        this.focus_items.$option = $option;
        $drop_item.addClass('zs-item-focus');
        this.zs_elements.$drop.scrollTop(
            $drop_item.position().top + this.zs_elements.$drop.scrollTop()
        );
    };

    Zs.prototype._blurFocusItem = function() {
        if (this.focus_items.$options) {
            this.focus_items.$options = false;
            this.focus_items.$option  = false;
            this.focus_items.$drop_items.removeClass('zs-item-focus');
            this.focus_items.$drop_items = false;
        }
    };

    Zs.prototype.setItem = function(ev, zs, option, data) {
        var that           = this,
            is_placeholder = false,
            fake_option    = false,
            no_options      = false,
            $my_option, my_data, my_text;

        // check if event triggered from here
        if (this.is_change_locked === true) {
            this.is_change_locked = false;
            return;
        }

        // get needed option
        if (option) {
            $my_option = this.$select.find(option);
        }
        if (option && $my_option.length) {
            this.$options.filter(':selected')
                .removeAttr('selected')
                .prop('selected', false);

            if (this.multiple) {
                $my_option.prop('selected', true);
            } else {
                $my_option.eq(0).prop('selected', true);
            }

            this.is_change_locked = true;
            if (check_prototype && this.orig_id) {
                window.$(this.orig_id).simulate('change');
            } else {
                this.$select.trigger('change', [$my_option]);
            }
            this.is_change_locked = false;
        } else {
            $my_option = this.$options.filter(':selected');
        }

        // remove active class from active elements
        if (this.zs_elements.$drop_items && this.zs_elements.$drop_items.length) {
            this.zs_elements.$drop_items.filter('.zs-active').removeClass('zs-active');
        }

        if (!$my_option.length) {
            if (this.$option_placeholder && this.$option_placeholder.length) {
                $my_option = this.$option_placeholder;
            } else {
                no_options = true;
            }
            fake_option = true;
        }

        // set select text
        if (this.zs_elements.$select_text) {
            my_text = this._getSelectText($my_option, no_options);

            this.zs_elements.$select_text.html(my_text);
        }

        if (this.zs_elements.$wrapper.hasClass('zs-placeholder-active')) {
            this.zs_elements.$wrapper.removeClass('zs-placeholder-active');
        }

        if (!fake_option) {
            if (this.multiple) {
                this.current.$option    = $my_option;
                if (this.zs_elements.$drop_items && this.zs_elements.$drop_items.length) {
                    this.current.$drop_item = $();
                }
                $my_option.each(function() {
                    var $temp_item;

                    my_data = $(this).data('zs_data');
                    if (my_data) {
                        if (that.zs_elements.$drop_items && that.zs_elements.$drop_items.length) {
                            my_data.$drop_item
                                .addClass('zs-active');

                            $temp_item              = that.current.$drop_item;
                            that.current.$drop_item = $temp_item.add(my_data.$drop_item);
                        }
                        if (my_data.is_placeholder) {
                            is_placeholder = true;
                        }
                    }
                });
                if ((!data || !data.multi_shift) && that.zs_elements.$drop_items && that.zs_elements.$drop_items.length) {
                    this.current.$drop_item_point = that.current.$drop_item.eq(-1);
                    this.current.$option_point    = that.current.$option.eq(-1);
                }
            } else {
                $my_option = $my_option.eq(0);
                my_data    = $my_option.data('zs_data');
                if (my_data && my_data.$drop_item) {
                    my_data.$drop_item
                        .addClass('zs-active');
                    this.current.$drop_item = my_data.$drop_item;
                }
                if (my_data && my_data.is_placeholder) {
                    is_placeholder = true;
                }
                this.current.$option = $my_option;
            }
        }
        if (is_placeholder && $my_option.length === 1 || fake_option) {
            this.zs_elements.$wrapper.addClass('zs-placeholder-active');
        }

        this.trigger('setItemAfter');
    };

    Zs.prototype.setPrev = function() {
        var current_index = this.current.$option ?
                this.$options.index(this.current.$option) : 1,
            tmp_max, tmp_data, $tmp_option;

        if (current_index) {
            tmp_max = current_index;
            for (; tmp_max--;) {
                $tmp_option = this.$options.eq(tmp_max);
                tmp_data = $tmp_option.data('zs_data');
                if (tmp_data && tmp_data.enable) {
                    this.trigger('setItem', $tmp_option);
                    if (this.multiple) {
                        this.current.$option_focus = $tmp_option;
                    }
                    break;
                }
            }
        }
    };

    Zs.prototype.setNext = function() {
        var current_index = this.current.$option ?
                this.$options.index(this.current.$option) : -1,
            tmp_i, tmp_data, $tmp_option;

        if (current_index < this.$options.length - 1) {
            for (tmp_i = current_index; tmp_i < this.$options.length - 1; tmp_i++) {
                $tmp_option = this.$options.eq(tmp_i + 1);
                tmp_data    = $tmp_option.data('zs_data');
                if (tmp_data && tmp_data.enable) {
                    this.trigger('setItem', $tmp_option);
                    if (this.multiple) {
                        this.current.$option_focus = $tmp_option;
                    }
                    break;
                }
            }
        }
    };

    Zs.prototype.open = function() {
        if (this.is_open) {
            return;
        }

        var gen_top_w, gen_top_d, height_d, off_pos_d;

        this.zs_elements.$wrapper.addClass('zs-open');

        // check drop menu for position
        if (this.options.open_top && this.zs_elements.$drop && this.zs_elements.$drop.length) {
            if (this.utilities.$window[0].innerHeight) {
                gen_top_w = this.utilities.$window[0].innerHeight + this.utilities.$window.scrollTop();
            } else {
                gen_top_w = this.utilities.$window.height() + this.utilities.$window.scrollTop();
            }
            height_d  = this.zs_elements.$drop.outerHeight(true);
            off_pos_d = this.zs_elements.$drop.offset().top;
            gen_top_d = off_pos_d + height_d;
            if (gen_top_w < gen_top_d && off_pos_d - height_d >= 0) {
                this.zs_elements.$wrapper.addClass('zs-open-top');
            }
        }

        this.is_open = true;

        this.trigger('openAfter');
    };

    Zs.prototype.close = function() {
        if (!this.is_open) {
            return;
        }

        this.zs_elements.$wrapper.removeClass('zs-open');

        if (this.zs_elements.$wrapper.hasClass('zs-open-top')) {
            this.zs_elements.$wrapper.removeClass('zs-open-top');
        }

        this._blurFocusItem();

        this.is_open = false;
        this.trigger('closeAfter');
    };

    Zs.prototype.refresh = function() {
        this.trigger('destroy');
        if (this.lazy_timer_id !== false) {
            clearTimeout(this.lazy_timer_id);
            this.lazy_timer_id = false;
        }
        if (!this.$select.data('zs_data')) {
            this.$select.data('zs_data', new Zs(this.$select, this.options));
        }
    };

    Zs.prototype.enable = function() {
        if (this.is_enable) {
            return;
        }
        this.is_enable = true;
        if (this.$select.attr('disabled')) {
            this.$select.removeAttr('disabled')
        }
        this.zs_elements.$wrapper.removeClass('zs-disabled');
    };

    Zs.prototype.disable = function() {
        if (!this.is_enable) {
            return;
        }
        this.is_enable = false;
        if (this.is_open && (this.multiple && !this.options.multiple.drop)) {
            this.trigger('close');
        }
        if (!this.$select.attr('disabled')) {
            this.$select.attr('disabled', true);
        }
        this.zs_elements.$wrapper.addClass('zs-disabled');
    };

    Zs.prototype.destroy = function() {
        var select_data = this.$select.data('zs_data');
        if (!select_data) {
            return;
        }

        $.each(this.plugins, $.proxy(function(key, plugin) {
            if (plugin.destroy) {
                plugin.destroy();
            }
        }, this));

        this.utilities.$document.off('.zselect' + this.select_id);

        this.$options.removeData('zs_data');
        this.$select
            .insertBefore(this.zs_elements.$wrapper)
            .off('.zselect')
            .removeData('zs_data')
            .attr('tabindex', this.zs_elements.$wrapper.attr('tabindex'));

        this.zs_elements.$wrapper.remove();
    };

    $.fn.zselect = function(options) {
        return this.each(function() {
            var $self = $(this);
            if (!$self.is('select')) {
                return;
            }
            if (!$self.data('zs_data')) {
                $self.data('zs_data', new Zs(this, options));
            }
        });
    };

    $.fn.zselect.Constructor = Zs;
})(jQuery);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJsaWIvanF1ZXJ5LnpzZWxlY3QubWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIVxyXG4gKiBDdXN0b20gc2VsZWN0IHBsdWdpbiBmb3IgalF1ZXJ5ICh6c2VsZWN0IHYwLjIuMCBiZXRhKVxyXG4gKlxyXG4gKiBBdXRob3I6IE1heGltIFBvcG92IDxQb3BvdkBibHVlZm91bnRhaW5tZWRpYS5jb20+XHJcbiAqXHJcbiAqIERhdGU6IDI1LzExLzIwMTRcclxuICogRGVwZW5kcyBvbiBsaWJyYXJ5OiBqUXVlcnkgMS45K1xyXG4gKlxyXG4gKi9cclxuKGZ1bmN0aW9uKCQsIHVuZGVmaW5lZCkge1xyXG4gICAgJ3VzZSBzdHJpY3QnO1xyXG4gICAgdmFyIHRvdWNoX2VuYWJsZSA9ICgoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSB8fCAobmF2aWdhdG9yLk1heFRvdWNoUG9pbnRzID4gMCkgfHwgKG5hdmlnYXRvci5tc01heFRvdWNoUG9pbnRzID4gMCkpLFxyXG4gICAgICAgIGNhbGxiYWNrcyxcclxuICAgICAgICBjaGVja19wcm90b3R5cGUgPSB0eXBlb2YgUHJvdG90eXBlICE9PSAndW5kZWZpbmVkJztcclxuXHJcbiAgICAvLyBhZGFwdGF0aW9uIGZvciBwcm90b3R5cGVcclxuICAgIGlmIChjaGVja19wcm90b3R5cGUpIHtcclxuICAgICAgICAoZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgdmFyIGV2ZW50TWF0Y2hlcnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ0hUTUxFdmVudHMnOiAvXig/OmxvYWR8dW5sb2FkfGFib3J0fGVycm9yfHNlbGVjdHxjaGFuZ2V8c3VibWl0fHJlc2V0fGZvY3VzfGJsdXJ8cmVzaXplfHNjcm9sbCkkLyxcclxuICAgICAgICAgICAgICAgICAgICAnTW91c2VFdmVudHMnOiAvXig/OmNsaWNrfG1vdXNlKD86ZG93bnx1cHxvdmVyfG1vdmV8b3V0KSkkL1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGRlZmF1bHRPcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHBvaW50ZXJYOiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIHBvaW50ZXJZOiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIGJ1dHRvbjogMCxcclxuICAgICAgICAgICAgICAgICAgICBjdHJsS2V5OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBhbHRLZXk6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIHNoaWZ0S2V5OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBtZXRhS2V5OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBidWJibGVzOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIGNhbmNlbGFibGU6IHRydWVcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBFdmVudC5zaW11bGF0ZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50TmFtZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZXh0ZW5kKGRlZmF1bHRPcHRpb25zLCBhcmd1bWVudHNbMl0gfHwgeyB9KSxcclxuICAgICAgICAgICAgICAgICAgICBvRXZlbnQsIGV2ZW50VHlwZSA9IG51bGwsIG5hbWU7XHJcblxyXG4gICAgICAgICAgICAgICAgZWxlbWVudCA9IHdpbmRvdy4kKGVsZW1lbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobmFtZSBpbiBldmVudE1hdGNoZXJzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50TWF0Y2hlcnNbbmFtZV0udGVzdChldmVudE5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50VHlwZSA9IG5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWV2ZW50VHlwZSl7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdPbmx5IEhUTUxFdmVudHMgYW5kIE1vdXNlRXZlbnRzIGludGVyZmFjZXMgYXJlIHN1cHBvcnRlZCcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5jcmVhdGVFdmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG9FdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KGV2ZW50VHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50VHlwZSA9PSAnSFRNTEV2ZW50cycpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb0V2ZW50LmluaXRFdmVudChldmVudE5hbWUsIG9wdGlvbnMuYnViYmxlcywgb3B0aW9ucy5jYW5jZWxhYmxlKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvRXZlbnQuaW5pdE1vdXNlRXZlbnQoZXZlbnROYW1lLCBvcHRpb25zLmJ1YmJsZXMsIG9wdGlvbnMuY2FuY2VsYWJsZSwgZG9jdW1lbnQuZGVmYXVsdFZpZXcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmJ1dHRvbiwgb3B0aW9ucy5wb2ludGVyWCwgb3B0aW9ucy5wb2ludGVyWSwgb3B0aW9ucy5wb2ludGVyWCwgb3B0aW9ucy5wb2ludGVyWSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY3RybEtleSwgb3B0aW9ucy5hbHRLZXksIG9wdGlvbnMuc2hpZnRLZXksIG9wdGlvbnMubWV0YUtleSwgb3B0aW9ucy5idXR0b24sIGVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQob0V2ZW50KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5jbGllbnRYID0gb3B0aW9ucy5wb2ludGVyWDtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNsaWVudFkgPSBvcHRpb25zLnBvaW50ZXJZO1xyXG4gICAgICAgICAgICAgICAgICAgIG9FdmVudCA9IE9iamVjdC5leHRlbmQoZG9jdW1lbnQuY3JlYXRlRXZlbnRPYmplY3QoKSwgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5maXJlRXZlbnQoJ29uJyArIGV2ZW50TmFtZSwgb0V2ZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50O1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBFbGVtZW50LmFkZE1ldGhvZHMoeyBzaW11bGF0ZTogRXZlbnQuc2ltdWxhdGUgfSk7XHJcbiAgICAgICAgfSkoKVxyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIFpzKGVsZW1lbnQsIG9wdGlvbnMpIHtcclxuICAgICAgICB2YXIgJG9wdGlvbl9wbGFjZWhvbGRlcjtcclxuXHJcbiAgICAgICAgdGhpcy4kc2VsZWN0ID0gJChlbGVtZW50KTtcclxuXHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gJC5leHRlbmQodHJ1ZSwge30sIFpzLmRlZmF1bHRzLCBvcHRpb25zKTtcclxuXHJcbiAgICAgICAgdGhpcy56c19lbGVtZW50cyA9IHtcclxuICAgICAgICAgICAgJHdyYXBwZXIgICAgOiBmYWxzZSxcclxuICAgICAgICAgICAgJHNlbGVjdF90ZXh0OiBmYWxzZSxcclxuICAgICAgICAgICAgJHNlbGVjdF9idG4gOiBmYWxzZSxcclxuICAgICAgICAgICAgJHNlbGVjdCAgICAgOiBmYWxzZSxcclxuICAgICAgICAgICAgJGRyb3AgICAgICAgOiBmYWxzZSxcclxuICAgICAgICAgICAgJGRyb3BfaXRlbXMgOiBmYWxzZSxcclxuICAgICAgICAgICAgJHBsYWNlaG9sZGVyOiBmYWxzZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuY3VycmVudCA9IHtcclxuICAgICAgICAgICAgJGRyb3BfaXRlbSAgOiBmYWxzZSxcclxuICAgICAgICAgICAgJG9wdGlvbiAgICAgOiBmYWxzZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5mb2N1c19pdGVtcyA9IHtcclxuICAgICAgICAgICAgJGRyb3BfaXRlbXMgOiBmYWxzZSxcclxuICAgICAgICAgICAgJG9wdGlvbnMgICAgOiBmYWxzZSxcclxuICAgICAgICAgICAgJG9wdGlvbiAgICAgOiBmYWxzZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKHRoaXMuJHNlbGVjdC5hdHRyKCdtdWx0aXBsZScpKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXVsdGlwbGUgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnQuJGRyb3BfaXRlbV9wb2ludCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnQuJG9wdGlvbl9wb2ludCAgICA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnQuJG9wdGlvbl9mb2N1cyAgICA9IGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubXVsdGlwbGUgPSBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuJG9wdGlvbnMgICAgICAgICAgICA9IHRoaXMuJHNlbGVjdC5maW5kKCdvcHRpb24nKTtcclxuICAgICAgICAkb3B0aW9uX3BsYWNlaG9sZGVyICAgICAgPSB0aGlzLiRvcHRpb25zLmZpbHRlcignW3ZhbHVlPVwiJyArIHRoaXMub3B0aW9ucy5wbGFjZWhvbGRlci52YWx1ZSArICdcIl0nKTtcclxuICAgICAgICB0aGlzLiRvcHRpb25fcGxhY2Vob2xkZXIgPSAkb3B0aW9uX3BsYWNlaG9sZGVyLmxlbmd0aCA/ICRvcHRpb25fcGxhY2Vob2xkZXIgOiBmYWxzZTtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLm5hdGl2ZV9tZW51ICYmICF0aGlzLm11bHRpcGxlKSB7XHJcbiAgICAgICAgICAgICRvcHRpb25fcGxhY2Vob2xkZXIuZGF0YSgnenNfZGF0YScsIHtcclxuICAgICAgICAgICAgICAgIGlzX3BsYWNlaG9sZGVyICA6IHRydWVcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlYWR5ID0ge1xyXG4gICAgICAgICAgICBzZWxlY3QgIDogZmFsc2UsXHJcbiAgICAgICAgICAgIGRyb3AgICAgOiBmYWxzZVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuaXNfY2hhbmdlX2xvY2tlZCA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLmlzX29wZW4gICA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLmluX2ZvY3VzICA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLmlzX2VuYWJsZSA9IHRydWU7XHJcblxyXG4gICAgICAgIHRoaXMub3JpZ19pZCAgID0gdGhpcy4kc2VsZWN0LmF0dHIoJ2lkJyk7XHJcblxyXG4gICAgICAgIHRoaXMubGF6eV90aW1lcl9pZCA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLnNlbGVjdF9pZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgdGhpcy51dGlsaXRpZXMuZ2V0UmFuZG9tSW50KDAsIDUwMCk7XHJcblxyXG4gICAgICAgIHRoaXMucGx1Z2lucyA9IHt9O1xyXG4gICAgICAgICQuZWFjaChacy5QbHVnaW5zLCAkLnByb3h5KGZ1bmN0aW9uKGtleSwgcGx1Z2luKSB7XHJcbiAgICAgICAgICAgIHRoaXMucGx1Z2luc1trZXlbMF0udG9Mb3dlckNhc2UoKSArIGtleS5zbGljZSgxKV1cclxuICAgICAgICAgICAgICAgID0gbmV3IHBsdWdpbih0aGlzKTtcclxuICAgICAgICB9LCB0aGlzKSk7XHJcblxyXG4gICAgICAgIHRoaXMuX2FkZFRyaWdnZXJhYmxlRXZlbnRzKCk7XHJcbiAgICAgICAgdGhpcy5pbml0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gb3B0aW9uc1xyXG4gICAgWnMuZGVmYXVsdHMgPSB7XHJcbiAgICAgICAgd2lkdGggICAgICAgICAgIDogdHJ1ZSwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHpzZWxlY3Qgd2lkdGggKHRydWUsIGZhbHNlLCBmaXhlZCBudW1iZXIpXHJcbiAgICAgICAgaGlkZV91c2luZ19qcyAgIDogZmFsc2UsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhvdyB0byBoaWRlIHpzZWxlY3QgKHRydWUsIGZhbHNlKVxyXG4gICAgICAgIHRlbXBsYXRlczogeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB6c2VsZWN0IGVsZW1lbnRzIHRlbXBsYXRlcywgZG9uYHQgdXNlIGNoYXJhY3RlcnMgYmVmb3JlICc8JyBodHRwOi8vc3RhZ2UuanF1ZXJ5LmNvbS91cGdyYWRlLWd1aWRlLzEuOS8janF1ZXJ5LWh0bWxzdHJpbmctdmVyc3VzLWpxdWVyeS1zZWxlY3RvcnN0cmluZ1xyXG4gICAgICAgICAgICBzZWxlY3QgICAgICA6ICc8ZGl2IGNsYXNzPVwienMtdGV4dFwiPjwvZGl2PicsICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlbGVjdCBlbGVtZW50cywgeW91IGNhbiBhbHNvIGFkZCBlbGVtZW50ICg8ZGl2IGNsYXNzPVwienMtYnRuXCI+PC9kaXY+KVxyXG4gICAgICAgICAgICBkcm9wICAgICAgICA6ICc8ZGl2IGNsYXNzPVwienMtZHJvcFwiPnt7aXRlbXN9fTwvZGl2PicsICAgICAgICAgICAgICAgICAgIC8vIGRyb3AgbWVudVxyXG4gICAgICAgICAgICBkcm9wX2l0ZW0gICA6ICc8ZGl2IGNsYXNzPVwienMtZHJvcC1pdGVtXCI+e3t0ZXh0fX08L2Rpdj4nLCAgICAgICAgICAgICAgIC8vIGRyb3AgbWVudSBpdGVtXHJcbiAgICAgICAgICAgIG9yaWdpbl9maXJzdDogdHJ1ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluc2VydCBvcmlnaW5hbCBzZWxlY3QgYXMgZmlyc3QgZWxlbWVudCBpbiB3cmFwcGVyXHJcbiAgICAgICAgfSxcclxuICAgICAgICBidWlsZFNlbGVjdFRleHQgICA6IGZhbHNlLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZnVuY3Rpb24gZm9yIGJ1aWxkIHNlbGVjdCB0ZXh0XHJcbiAgICAgICAgYnVpbGREcm9wSXRlbVRleHQgOiBmYWxzZSwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZ1bmN0aW9uIGZvciBidWlsZCBlYWNoIGRyb3AgaXRlbSBmcm9tIG9wdGlvblxyXG4gICAgICAgIGxhenk6IHtcclxuICAgICAgICAgICAgaXRlbXMgOiAxMDAwLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaG93IG1hbnkgaW4gb25lIGl0ZXJhdGlvbiBwcm9ncmVzc2l2ZSBsb2FkaW5nXHJcbiAgICAgICAgICAgIHRpbWUgIDogMTAwLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRpbWUgYmV0d2VlbiBpdGVyYXRpb25zXHJcbiAgICAgICAgICAgIHRleHQgIDogJ0xvYWRpbmcuLi4nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRleHQgYmVmb3JlIGFsbCBkcm9wIGl0ZW1zIGxvYWRcclxuICAgICAgICB9LFxyXG4gICAgICAgIHBsYWNlaG9sZGVyICAgICA6IHtcclxuICAgICAgICAgICAgdmFsdWU6ICcnLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUGxhY2Vob2xkZXIgb3B0aW9uIHZhbHVlIGRldGVjdFxyXG4gICAgICAgICAgICBub19vcHRpb25zOiAnTm8gaXRlbXMgc2VsZWN0ZWQnICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBQbGFjZWhvbGRlciBvcHRpb24gdmFsdWUgZGV0ZWN0XHJcbiAgICAgICAgfSxcclxuICAgICAgICBtdWx0aXBsZSAgICAgICAgOiB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbXVsdGlwbGUgb3B0aW9uc1xyXG4gICAgICAgICAgICBoZWlnaHQ6IHRydWUsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBoZWlnaHQgb2YgZWxlbWVudHMgd3JhcHBlclxyXG4gICAgICAgICAgICBkcm9wICA6IGZhbHNlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1c2UgbXVsdGlwbGUgd2l0aCBpbiBtZW51XHJcbiAgICAgICAgfSxcclxuICAgICAgICBuYXRpdmVfbWVudSAgICAgOiBmYWxzZSwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG9uYHQgY3JlYXRlIGN1c3RvbSBkcm9wIG1lbnVcclxuICAgICAgICBvcGVuX3RvcCAgICAgICAgOiB0cnVlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHVybiBvbiBvcGVuIGRyb3AgZG93biB0byB0b3BcclxuICAgIH07XHJcblxyXG4gICAgLy8gY2FsbGJhY2tzXHJcbiAgICBjYWxsYmFja3MgPSB7XHJcbiAgICAgICAgaW5pdEJlZm9yZTogZmFsc2UsICAgICAgLy8gYmVmb3JlIGluaXRpYWxpemF0aW9uXHJcbiAgICAgICAgaW5pdEFmdGVyIDogZmFsc2UsICAgICAgLy8gYWZ0ZXIgaW5pdGlhbGl6YXRpb25cclxuICAgICAgICBkcm9wSXRlbUJlZm9yZTogZmFsc2UsICAvLyBiZWZvcmUgZHJvcCBpdGVtIGJ1aWxkXHJcbiAgICAgICAgZHJvcEl0ZW1BZnRlciA6IGZhbHNlLCAgLy8gYWZ0ZXIgZHJvcCBpdGVtIGJ1aWxkXHJcbiAgICAgICAgYnVpbGRBZnRlcjogZmFsc2UsICAgICAgLy8gYWZ0ZXIgYnVpbGQgRE9NIG9mIHpzZWxlY3RcclxuICAgICAgICBvcGVuQWZ0ZXIgOiBmYWxzZSwgICAgICAvLyBhZnRlciBkcm9wIG1lbnUgb3BlblxyXG4gICAgICAgIGNsb3NlQWZ0ZXI6IGZhbHNlLCAgICAgIC8vIGFmdGVyIGRyb3AgbWVudSBjbG9zZVxyXG4gICAgICAgIGRpc2FibGVJdGVtQWZ0ZXI6IGZhbHNlLC8vIGFmdGVyIGRpc2FibGUgSXRlbVxyXG4gICAgICAgIGVuYWJsZUl0ZW1BZnRlciA6IGZhbHNlLC8vIGFmdGVyIGVuYWJsZSBJdGVtXHJcbiAgICAgICAgc2V0SXRlbUFmdGVyICA6IGZhbHNlICAgLy8gYWZ0ZXIgc2V0IEl0ZW1cclxuICAgIH07XHJcblxyXG4gICAgWnMuUGx1Z2lucyA9IHt9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS56cyA9ICcwLjIuMCc7XHJcblxyXG4gICAgWnMucHJvdG90eXBlLnV0aWxpdGllcyA9IHtcclxuICAgICAgICAkd2luZG93ICAgICA6ICQod2luZG93KSxcclxuICAgICAgICAkZG9jdW1lbnQgICA6ICQoZG9jdW1lbnQpLFxyXG4gICAgICAgIHRvdWNoX2VuYWJsZTogdG91Y2hfZW5hYmxlLFxyXG4gICAgICAgIGtleUNvZGU6IHtcclxuICAgICAgICAgICAgQkFDS1NQQUNFOiA4LFxyXG4gICAgICAgICAgICBDT01NQTogMTg4LFxyXG4gICAgICAgICAgICBERUxFVEU6IDQ2LFxyXG4gICAgICAgICAgICBET1dOOiA0MCxcclxuICAgICAgICAgICAgRU5EOiAzNSxcclxuICAgICAgICAgICAgRU5URVI6IDEzLFxyXG4gICAgICAgICAgICBFU0NBUEU6IDI3LFxyXG4gICAgICAgICAgICBIT01FOiAzNixcclxuICAgICAgICAgICAgTEVGVDogMzcsXHJcbiAgICAgICAgICAgIFBBR0VfRE9XTjogMzQsXHJcbiAgICAgICAgICAgIFBBR0VfVVA6IDMzLFxyXG4gICAgICAgICAgICBQRVJJT0Q6IDE5MCxcclxuICAgICAgICAgICAgUklHSFQ6IDM5LFxyXG4gICAgICAgICAgICBTUEFDRTogMzIsXHJcbiAgICAgICAgICAgIFRBQjogOSxcclxuICAgICAgICAgICAgVVA6IDM4XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRSYW5kb21JbnQ6IGZ1bmN0aW9uKG1pbiwgbWF4KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpICsgbWluO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB0aGlzLnRyaWdnZXIoJ2luaXRCZWZvcmUnKTtcclxuXHJcbiAgICAgICAgLy8gYnVpbGQgenNlbGVjdCBET01cclxuICAgICAgICB0aGlzLl9idWlsZERvbSgpO1xyXG5cclxuICAgICAgICAvLyBhZGQgZXZlbnRzXHJcbiAgICAgICAgdGhpcy5fZXZlbnRzSW5pdCgpO1xyXG5cclxuICAgICAgICAvLyBoaWRlIHNlbGVjdFxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaGlkZV91c2luZ19qcyAmJlxyXG4gICAgICAgICAgICAhdGhpcy5vcHRpb25zLm5hdGl2ZV9tZW51KSB7XHJcbiAgICAgICAgICAgIHRoaXMuJHNlbGVjdC5oaWRlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy4kc2VsZWN0LmF0dHIoJ2Rpc2FibGVkJykpIHtcclxuICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdkaXNhYmxlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudHJpZ2dlcignaW5pdEFmdGVyJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5fYnVpbGREb20gPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB0aGlzLl9idWlsZERvbVdyYXBwZXIoKTtcclxuICAgICAgICBpZiAoKHRoaXMub3B0aW9ucy5uYXRpdmVfbWVudSAmJiAhdGhpcy5tdWx0aXBsZSkgfHxcclxuICAgICAgICAgICAgKHRoaXMub3B0aW9ucy5uYXRpdmVfbWVudSAmJiB0aGlzLm11bHRpcGxlICYmXHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMubXVsdGlwbGUuZHJvcCAmJiB0aGlzLnV0aWxpdGllcy50b3VjaF9lbmFibGUpKSB7XHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2J1aWxkRG9tRHJvcCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUgfHwgKHRoaXMubXVsdGlwbGUgJiYgdGhpcy5vcHRpb25zLm11bHRpcGxlLmRyb3ApKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2J1aWxkRG9tU2VsZWN0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudHJpZ2dlcignYnVpbGRBZnRlcicpO1xyXG4gICAgfTtcclxuXHJcbiAgICBacy5wcm90b3R5cGUuX2J1aWxkRG9tV3JhcHBlciA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciAkd3JhcHBlciAgICAgID0gJCgnPGRpdiBjbGFzcz1cInpzXCI+PC9kaXY+JyksXHJcbiAgICAgICAgICAgIG15X25hbWUgICAgICAgPSB0aGlzLiRzZWxlY3QuYXR0cignbmFtZScpLFxyXG4gICAgICAgICAgICBvcmlnX2NsYXNzZXMgID0gdGhpcy4kc2VsZWN0LmF0dHIoJ2NsYXNzJyksXHJcbiAgICAgICAgICAgIHRhYmluZGV4ICAgICAgPSB0aGlzLiRzZWxlY3QuYXR0cigndGFiaW5kZXgnKSxcclxuICAgICAgICAgICAgc2VsZWN0X3N0eWxlcyA9IHRoaXMuJHNlbGVjdC5hdHRyKCdzdHlsZScpLFxyXG4gICAgICAgICAgICBjbGFzc19hcnI7XHJcblxyXG4gICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHdyYXBwZXIgPSAkd3JhcHBlcjtcclxuXHJcbiAgICAgICAgLy8gc2V0IHNlbGVjdCBhdHRyaWJ1dGVzXHJcbiAgICAgICAgaWYgKHRoaXMub3JpZ19pZCkge1xyXG4gICAgICAgICAgICAkd3JhcHBlci5hdHRyKCdpZCcsIHRoaXMub3JpZ19pZCArICctenMnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG15X25hbWUpIHtcclxuICAgICAgICAgICAgJHdyYXBwZXIuYXR0cignZGF0YS1uYW1lJywgbXlfbmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcmlnX2NsYXNzZXMpIHtcclxuICAgICAgICAgICAgY2xhc3NfYXJyID0gJC50cmltKG9yaWdfY2xhc3Nlcykuc3BsaXQoJyAnKTtcclxuICAgICAgICAgICAgJC5lYWNoKGNsYXNzX2FyciwgZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICAgIGNsYXNzX2FycltpZF0gKz0gJy16cyc7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAkd3JhcHBlci5hZGRDbGFzcyhjbGFzc19hcnIuam9pbignICcpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNlbGVjdF9zdHlsZXMpIHtcclxuICAgICAgICAgICAgJHdyYXBwZXIuYXR0cignc3R5bGUnLCBzZWxlY3Rfc3R5bGVzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRhYmluZGV4KSB7XHJcbiAgICAgICAgICAgICR3cmFwcGVyLmF0dHIoJ3RhYmluZGV4JywgdGFiaW5kZXgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICR3cmFwcGVyLmF0dHIoJ3RhYmluZGV4JywgMCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuJHNlbGVjdC5hdHRyKHtcclxuICAgICAgICAgICAgdGFiaW5kZXg6IC0xXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIHNldCBzZWxlY3Qgd2lkdGhcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLndpZHRoICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAkd3JhcHBlci53aWR0aChcclxuICAgICAgICAgICAgICAgICh0aGlzLm9wdGlvbnMud2lkdGggPT09IHRydWUpID9cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLiRzZWxlY3Qub3V0ZXJXaWR0aCh0cnVlKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLndpZHRoXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoKHRoaXMub3B0aW9ucy5uYXRpdmVfbWVudSAmJiAhdGhpcy5tdWx0aXBsZSkgfHxcclxuICAgICAgICAgICAgKHRoaXMub3B0aW9ucy5uYXRpdmVfbWVudSAmJiB0aGlzLm11bHRpcGxlICYmXHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMubXVsdGlwbGUuZHJvcCAmJiB0aGlzLnV0aWxpdGllcy50b3VjaF9lbmFibGUpKSB7XHJcbiAgICAgICAgICAgICR3cmFwcGVyLmFkZENsYXNzKCd6cy1uYXRpdmUtbWVudScpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMubXVsdGlwbGUpIHtcclxuICAgICAgICAgICAgJHdyYXBwZXIuYWRkQ2xhc3MoJ3pzLW11bHRpcGxlJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLm11bHRpcGxlLmRyb3ApIHtcclxuICAgICAgICAgICAgJHdyYXBwZXIuYWRkQ2xhc3MoJ3pzLW11bHRpcGxlLWRyb3AnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnV0aWxpdGllcy50b3VjaF9lbmFibGUpIHtcclxuICAgICAgICAgICAgJHdyYXBwZXIuYWRkQ2xhc3MoJ3pzLXRvdWNoJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBpbnNlcnQgd3JhcHBlclxyXG4gICAgICAgICR3cmFwcGVyLmluc2VydEFmdGVyKHRoaXMuJHNlbGVjdClcclxuICAgICAgICAgICAgLmFwcGVuZCh0aGlzLiRzZWxlY3QpO1xyXG4gICAgfTtcclxuXHJcbiAgICBacy5wcm90b3R5cGUuX2J1aWxkRG9tU2VsZWN0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHRlbXBsYXRlID0gKHR5cGVvZiB0aGlzLm9wdGlvbnMudGVtcGxhdGVzLnNlbGVjdCA9PT0gJ2Z1bmN0aW9uJykgP1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLnRlbXBsYXRlcy5zZWxlY3QodGhpcy4kc2VsZWN0KSA6XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMudGVtcGxhdGVzLnNlbGVjdCxcclxuICAgICAgICAgICAgJHNlbGVjdCAgPSAkKCc8ZGl2PjwvZGl2PicpLmFwcGVuZCh0ZW1wbGF0ZSksXHJcbiAgICAgICAgICAgICR6c190ZXh0PSAkc2VsZWN0LmZpbmQoJy56cy10ZXh0JyksXHJcbiAgICAgICAgICAgICR6c19idG4gPSAkc2VsZWN0LmZpbmQoJy56cy1idG4nKTtcclxuXHJcbiAgICAgICAgaWYgKCR6c190ZXh0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLnpzX2VsZW1lbnRzLiRzZWxlY3RfdGV4dCA9ICR6c190ZXh0O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoJHpzX2J0bi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kc2VsZWN0X2J0biAgPSAkenNfYnRuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMubmF0aXZlX21lbnUgJiYgdGhpcy5yZWFkeS5kcm9wKSB7XHJcbiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2V0SXRlbScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLm5hdGl2ZV9tZW51KSB7XHJcbiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2V0SXRlbScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5uYXRpdmVfbWVudSAmJlxyXG4gICAgICAgICAgICAhdGhpcy5yZWFkeS5kcm9wICYmXHJcbiAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHNlbGVjdF90ZXh0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHNlbGVjdF90ZXh0LnRleHQodGhpcy5vcHRpb25zLmxhenkudGV4dCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlYWR5LnNlbGVjdCA9IHRydWU7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudGVtcGxhdGVzLm9yaWdpbl9maXJzdCkge1xyXG4gICAgICAgICAgICB0aGlzLnpzX2VsZW1lbnRzLiRzZWxlY3QgPSAkc2VsZWN0Lmluc2VydEFmdGVyKHRoaXMuJHNlbGVjdCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kc2VsZWN0ID0gJHNlbGVjdC5wcmVwZW5kVG8odGhpcy56c19lbGVtZW50cy4kd3JhcHBlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHNlbGVjdFxyXG4gICAgICAgICAgICAuY29udGVudHMoKVxyXG4gICAgICAgICAgICAudW53cmFwKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5fYnVpbGREb21Ecm9wID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIGRyb3BfaHRtbCA9ICh0eXBlb2YgdGhpcy5vcHRpb25zLnRlbXBsYXRlcy5kcm9wID09PSAnZnVuY3Rpb24nKSA/XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMudGVtcGxhdGVzLmRyb3AodGhpcy4kc2VsZWN0KSA6IHRoaXMub3B0aW9ucy50ZW1wbGF0ZXMuZHJvcCxcclxuICAgICAgICAgICAgdG1wX2lkICAgID0gJ3RtcCcgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICctJyArIHRoaXMudXRpbGl0aWVzLmdldFJhbmRvbUludCgwLCAxMDAwKSxcclxuICAgICAgICAgICAgJGRyb3Bfd3IgID0gJCgnPGRpdj48L2Rpdj4nKS5hcHBlbmQoXHJcbiAgICAgICAgICAgICAgICBkcm9wX2h0bWwucmVwbGFjZSgne3tpdGVtc319JywgJzxzcGFuIGlkPVwiJyArIHRtcF9pZCArICdcIj48L3NwYW4+JylcclxuICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgJHRtcF9kcm9wX2lubmVyID0gJGRyb3Bfd3IuZmluZCgnIycgKyB0bXBfaWQpO1xyXG5cclxuICAgICAgICB0aGlzLl9idWlsZERyb3BJdGVtc0FsbCgkdG1wX2Ryb3BfaW5uZXIpO1xyXG5cclxuICAgICAgICB0aGlzLnpzX2VsZW1lbnRzLiRkcm9wID0gJGRyb3Bfd3IuZmluZCgnLnpzLWRyb3AnKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMubXVsdGlwbGUgJiYgIXRoaXMub3B0aW9ucy5tdWx0aXBsZS5kcm9wKSB7XHJcbiAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJGRyb3AuYXR0cih7XHJcbiAgICAgICAgICAgICAgICB0YWJpbmRleDogLTFcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRlbXBsYXRlcy5vcmlnaW5fZmlyc3QpIHtcclxuICAgICAgICAgICAgJGRyb3Bfd3IuaW5zZXJ0QWZ0ZXIodGhpcy4kc2VsZWN0KVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICRkcm9wX3dyLmluc2VydEJlZm9yZSh0aGlzLiRzZWxlY3QpXHJcbiAgICAgICAgfVxyXG4gICAgICAgICRkcm9wX3dyXHJcbiAgICAgICAgICAgIC5jb250ZW50cygpXHJcbiAgICAgICAgICAgIC51bndyYXAoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMubXVsdGlwbGUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5tdWx0aXBsZS5oZWlnaHQgPT09IHRydWUgJiZcclxuICAgICAgICAgICAgICAgICEkLmlzTnVtZXJpYyh0aGlzLm9wdGlvbnMubXVsdGlwbGUuaGVpZ2h0KSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kZHJvcC5oZWlnaHQodGhpcy4kc2VsZWN0Lm91dGVySGVpZ2h0KCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMubXVsdGlwbGUuaGVpZ2h0ICE9PSB0cnVlICYmXHJcbiAgICAgICAgICAgICAgICAkLmlzTnVtZXJpYyh0aGlzLm9wdGlvbnMubXVsdGlwbGUuaGVpZ2h0KSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kZHJvcC5oZWlnaHQodGhpcy5vcHRpb25zLm11bHRpcGxlLmhlaWdodCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgJHRtcF9kcm9wX2lubmVyLnJlbW92ZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBacy5wcm90b3R5cGUuX2J1aWxkRG9tRHJvcEl0ZW0gPSBmdW5jdGlvbigkb3B0aW9uKSB7XHJcbiAgICAgICAgdGhpcy50cmlnZ2VyKCdkcm9wSXRlbUJlZm9yZScsICRvcHRpb24pO1xyXG5cclxuICAgICAgICB2YXIgdGV4dCAgICA9ICRvcHRpb24udGV4dCgpLFxyXG4gICAgICAgICAgICAkcmVzdWx0ID0gJCh0aGlzLm9wdGlvbnMudGVtcGxhdGVzLmRyb3BfaXRlbS5yZXBsYWNlKFxyXG4gICAgICAgICAgICAgICAgJ3t7dGV4dH19JyxcclxuICAgICAgICAgICAgICAgIHR5cGVvZiB0aGlzLm9wdGlvbnMuYnVpbGREcm9wSXRlbVRleHQgPT09ICdmdW5jdGlvbicgP1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5idWlsZERyb3BJdGVtVGV4dCgkb3B0aW9uKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dFxyXG4gICAgICAgICAgICApKSxcclxuICAgICAgICAgICAgdmFsdWUgICA9ICRvcHRpb24uYXR0cigndmFsdWUnKSxcclxuICAgICAgICAgICAgbXlfaWQgICA9ICRvcHRpb24uYXR0cignaWQnKSxcclxuICAgICAgICAgICAgdGl0bGUgICAgICA9ICRvcHRpb24uYXR0cigndGl0bGUnKSxcclxuICAgICAgICAgICAgc2VsZWN0ZWQgICA9ICRvcHRpb24uYXR0cignc2VsZWN0ZWQnKSxcclxuICAgICAgICAgICAgZGlzYWJsZWQgICA9ICRvcHRpb24uYXR0cignZGlzYWJsZWQnKSxcclxuICAgICAgICAgICAgb3JpZ19jbGFzcyA9ICRvcHRpb24uYXR0cignY2xhc3MnKSxcclxuICAgICAgICAgICAgYXR0cmlidXRlcyA9IHt9LFxyXG4gICAgICAgICAgICBjbGFzc2VzICAgID0gW10sXHJcbiAgICAgICAgICAgICRteV9kcm9waXRlbTtcclxuXHJcbiAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGF0dHJpYnV0ZXNbJ2RhdGEtdmFsdWUnXSA9IHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobXlfaWQpIHtcclxuICAgICAgICAgICAgYXR0cmlidXRlc1snaWQnXSA9IG15X2lkICsgJy16cy1kcm9wLWl0ZW0nO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGl0bGUpIHtcclxuICAgICAgICAgICAgYXR0cmlidXRlc1sndGl0bGUnXSA9IHRpdGxlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc2VsZWN0ZWQpIHtcclxuICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKCd6cy1hY3RpdmUnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9yaWdfY2xhc3MpIHtcclxuICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKG9yaWdfY2xhc3MpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgJG15X2Ryb3BpdGVtID0gJCgnPGRpdj48L2Rpdj4nKS5hcHBlbmQoJHJlc3VsdClcclxuICAgICAgICAgICAgLmZpbmQoJy56cy1kcm9wLWl0ZW0nKVxyXG4gICAgICAgICAgICAuYXR0cihhdHRyaWJ1dGVzKVxyXG4gICAgICAgICAgICAuYWRkQ2xhc3MoY2xhc3Nlcy5qb2luKCcgJykpO1xyXG5cclxuICAgICAgICBpZiAoZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgJG15X2Ryb3BpdGVtXHJcbiAgICAgICAgICAgICAgICAuZGF0YSgnenNfZGF0YScsIHtcclxuICAgICAgICAgICAgICAgICAgICBlbmFibGU6IGZhbHNlXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgJG9wdGlvbi5kYXRhKCd6c19kYXRhJywge1xyXG4gICAgICAgICAgICAgICAgZW5hYmxlOiBmYWxzZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkbXlfZHJvcGl0ZW1cclxuICAgICAgICAgICAgICAgIC5kYXRhKCd6c19kYXRhJywge1xyXG4gICAgICAgICAgICAgICAgICAgIGVuYWJsZTogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICRvcHRpb24uZGF0YSgnenNfZGF0YScsIHtcclxuICAgICAgICAgICAgICAgIGVuYWJsZTogdHJ1ZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudHJpZ2dlcignZHJvcEl0ZW1BZnRlcicsICRvcHRpb24sICRyZXN1bHQpO1xyXG4gICAgICAgIHJldHVybiAkcmVzdWx0O1xyXG4gICAgfTtcclxuXHJcbiAgICBacy5wcm90b3R5cGUuYWRkSXRlbSA9IGZ1bmN0aW9uKGV2LCBvcHRpb24sIGRhdGEpIHtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5fYnVpbGREcm9wSXRlbXNBbGwgPSBmdW5jdGlvbigkaG9vaykge1xyXG4gICAgICAgIHZhciB0aGF0ICAgICAgICA9IHRoaXMsXHJcbiAgICAgICAgICAgICRob29rX2l0ZW0gID0gJGhvb2ssXHJcbiAgICAgICAgICAgICR0ZW1wX29wdGdyb3VwICAgICAgPSBmYWxzZSxcclxuICAgICAgICAgICAgJHRlbXBfZHJvcG9wdGdyb3VwICA9IGZhbHNlLFxyXG4gICAgICAgICAgICAkdGVtcF9vcHRncm91cF9kYXRhID0ge30sXHJcbiAgICAgICAgICAgIGl0ZW1fY291bnRfbm93ICAgPSAwLCAgIC8vIGNvdW50ZXIgaW5jcmVhc2UgYnkgZWFjaCBpdGVtXHJcbiAgICAgICAgICAgIGl0ZW1fY291bnRfZ3JvdXAgPSAxOyAgIC8vIGNvdW50ZXIgaW5jcmVhc2UgYnkgb3B0aW9uIC0+IGxhenkuaXRlbXNcclxuXHJcbiAgICAgICAgdGhhdC56c19lbGVtZW50cy4kZHJvcF9pdGVtcyA9ICQoKTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gbGF6eUxvYWQoKSB7XHJcbiAgICAgICAgICAgIHRoYXQuJG9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaWQgPj0gaXRlbV9jb3VudF9ub3c7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuZWFjaChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiBsb3RzIG9mIG9wdGlvbnNcclxuICAgICAgICAgICAgICAgICAgICBpdGVtX2NvdW50X25vdyArPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtX2NvdW50X25vdyA+IHRoYXQub3B0aW9ucy5sYXp5Lml0ZW1zICogaXRlbV9jb3VudF9ncm91cCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtX2NvdW50X2dyb3VwICs9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1fY291bnRfbm93ICAgLT0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5sYXp5X3RpbWVyX2lkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LmxhenlfdGltZXJfaWQgIT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoYXQubGF6eV90aW1lcl9pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5sYXp5X3RpbWVyX2lkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXp5TG9hZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGF0Lm9wdGlvbnMubGF6eS50aW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gYnVpbGQgaXRlbVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiAgPSAkKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSAgPSAkc2VsZi5hdHRyKCd2YWx1ZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc19wbGFjZWhvbGRlciA9IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkbXlfb3B0Z3JvdXAgPSAkc2VsZi5jbG9zZXN0KCdvcHRncm91cCcpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkcmVzdWx0X2l0ZW0sICR0ZW1wX2VsLCAkdGVtcF93cmFwLCAkZHJvcF9pdGVtLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25fZGF0YSwgb3B0aW9uX2RhdGFfb2xkLCBkcm9waXRlbV9kYXRhLCBkcm9waXRlbV9kYXRhX29sZDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGF0Lm9wdGlvbnMudGVtcGxhdGVzLmRyb3BfaXRlbSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkcmVzdWx0X2l0ZW0gPSB0aGF0Lm9wdGlvbnMudGVtcGxhdGVzLmRyb3BfaXRlbSgkc2VsZlswXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHJlc3VsdF9pdGVtID0gdGhhdC5fYnVpbGREb21Ecm9wSXRlbSgkc2VsZik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAkdGVtcF93cmFwID0gJCgnPGRpdj48L2Rpdj4nKTtcclxuICAgICAgICAgICAgICAgICAgICAkZHJvcF9pdGVtID0gJHRlbXBfd3JhcC5hcHBlbmQoJHJlc3VsdF9pdGVtKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmluZCgnLnpzLWRyb3AtaXRlbScpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoJHJlc3VsdF9pdGVtICYmIHR5cGVvZiAkcmVzdWx0X2l0ZW0uaW5zZXJ0QWZ0ZXIgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBfd3JhcC5pbnNlcnRBZnRlcigkaG9va19pdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBwbGFjZWhvbGRlclxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlID09PSB0aGF0Lm9wdGlvbnMucGxhY2Vob2xkZXIudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuenNfZWxlbWVudHMuJHBsYWNlaG9sZGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnpzX2VsZW1lbnRzLiRwbGFjZWhvbGRlciA9IHRoYXQuenNfZWxlbWVudHMuJHBsYWNlaG9sZGVyLmFkZCgkZHJvcF9pdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuenNfZWxlbWVudHMuJHBsYWNlaG9sZGVyID0gJGRyb3BfaXRlbTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkZHJvcF9pdGVtLmFkZENsYXNzKCd6cy1kcm9wLXBsYWNlaG9sZGVyJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzX3BsYWNlaG9sZGVyID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHNldCBkYXRhICYmIG9wdGdyb3VwXHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uX2RhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRkcm9wX2l0ZW0gICAgICA6ICRkcm9wX2l0ZW0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb25fZWxlbWVudCA6ICRyZXN1bHRfaXRlbSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaXNfcGxhY2Vob2xkZXIgIDogaXNfcGxhY2Vob2xkZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZSAgICAgICAgICA6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbl9kYXRhX29sZCA9ICRzZWxmLmRhdGEoJ3pzX2RhdGEnKSB8fCB7fTtcclxuICAgICAgICAgICAgICAgICAgICBkcm9waXRlbV9kYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkb3B0aW9uICAgICAgICAgOiAkc2VsZixcclxuICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbl9lbGVtZW50IDogJHJlc3VsdF9pdGVtLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpc19wbGFjZWhvbGRlciAgOiBpc19wbGFjZWhvbGRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlICAgICAgICAgIDogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgZHJvcGl0ZW1fZGF0YV9vbGQgPSAkZHJvcF9pdGVtLmRhdGEoJ3pzX2RhdGEnKSB8fCB7fTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCRteV9vcHRncm91cC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkdGVtcF9vcHRncm91cCB8fCAkbXlfb3B0Z3JvdXBbMF0gIT09ICR0ZW1wX29wdGdyb3VwWzBdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcF9vcHRncm91cCA9ICRteV9vcHRncm91cDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wX29wdGdyb3VwX2RhdGEubGFiZWwgICAgPSAkdGVtcF9vcHRncm91cC5hdHRyKCdsYWJlbCcpIHx8ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBfb3B0Z3JvdXBfZGF0YS5kaXNhYmxlZCA9ICR0ZW1wX29wdGdyb3VwLmF0dHIoJ2Rpc2FibGVkJykgfHwgZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcF9vcHRncm91cF9kYXRhLmNsYXNzZXMgID0gJHRlbXBfb3B0Z3JvdXAuYXR0cignY2xhc3MnKSB8fCAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcF9vcHRncm91cF9kYXRhLmRpc2FibGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRlbXBfb3B0Z3JvdXBfZGF0YS5jbGFzc2VzICs9ICcgenMtZHJvcC1kaXNhYmxlZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGVtcF9kcm9wb3B0Z3JvdXAgPSAkKCc8ZGl2IGNsYXNzPVwienMtZHJvcC1vcHRncm91cFwiPicgKyAkdGVtcF9vcHRncm91cF9kYXRhLmxhYmVsICsgJzwvZGl2PicpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmluc2VydEJlZm9yZSgkdGVtcF93cmFwKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdkYXRhLWxhYmVsJywgJHRlbXBfb3B0Z3JvdXBfZGF0YS5sYWJlbClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJHRlbXBfb3B0Z3JvdXBfZGF0YS5jbGFzc2VzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkcm9waXRlbV9kYXRhLiRkcm9wX29wdGdyb3VwID0gJHRlbXBfZHJvcG9wdGdyb3VwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25fZGF0YS4kb3B0Z3JvdXAgICAgICAgID0gJHRlbXBfb3B0Z3JvdXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGVtcF9vcHRncm91cF9kYXRhLmRpc2FibGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25fZGF0YV9vbGQuZW5hYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgJGRyb3BfaXRlbS5hZGRDbGFzcygnenMtZHJvcC1pbm9wdGdyb3VwJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25fZGF0YV9vbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNlbGYuZGF0YSgnenNfZGF0YScsICQuZXh0ZW5kKG9wdGlvbl9kYXRhLCBvcHRpb25fZGF0YV9vbGQpKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2VsZi5kYXRhKCd6c19kYXRhJywgb3B0aW9uX2RhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZHJvcGl0ZW1fZGF0YV9vbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGRyb3BfaXRlbS5kYXRhKCd6c19kYXRhJywgJC5leHRlbmQoZHJvcGl0ZW1fZGF0YSwgZHJvcGl0ZW1fZGF0YV9vbGQpKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkZHJvcF9pdGVtLmRhdGEoJ3pzX2RhdGEnLCBkcm9waXRlbV9kYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGVcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uX2RhdGFfb2xkICYmICFvcHRpb25fZGF0YV9vbGQuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignZGlzYWJsZUl0ZW0nLCAkc2VsZik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBpbml0IGRyb3AgaXRlbSBldmVudHNcclxuICAgICAgICAgICAgICAgICAgICB0aGF0Ll9ldmVudHNEcm9wSXRlbSgkZHJvcF9pdGVtLCAkc2VsZik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICR0ZW1wX2VsID0gdGhhdC56c19lbGVtZW50cy4kZHJvcF9pdGVtcztcclxuICAgICAgICAgICAgICAgICAgICB0aGF0LnpzX2VsZW1lbnRzLiRkcm9wX2l0ZW1zID0gJHRlbXBfZWwuYWRkKCRkcm9wX2l0ZW0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoJGhvb2tfaXRlbVswXSAhPT0gJGhvb2tbMF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGhvb2tfaXRlbS5jb250ZW50cygpLnVud3JhcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAkaG9va19pdGVtID0gJHRlbXBfd3JhcDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm11bHRpcGxlICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1fY291bnRfbm93ID09PSB0aGF0LiRvcHRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnJlYWR5LmRyb3AgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbV9jb3VudF9ub3cgPT09IHRoYXQuJG9wdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRob29rX2l0ZW0uY29udGVudHMoKS51bndyYXAoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1fY291bnRfbm93ID09PSB0aGF0LiRvcHRpb25zLmxlbmd0aCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAodGhhdC5yZWFkeS5zZWxlY3QgfHwgdGhhdC5tdWx0aXBsZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsYXp5TG9hZCgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBacy5wcm90b3R5cGUuZGlzYWJsZUl0ZW0gPSBmdW5jdGlvbihldiwgenMsIG9wdGlvbikge1xyXG4gICAgICAgIGlmICghb3B0aW9uKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyICRvcHRpb25zID0gdGhpcy4kb3B0aW9uc1xyXG4gICAgICAgICAgICAuZmlsdGVyKG9wdGlvbilcclxuICAgICAgICAgICAgLmVhY2goZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgJHNlbGYgPSAkKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgICAgIG15X2RhdGEgPSAkc2VsZi5kYXRhKCd6c19kYXRhJyksXHJcbiAgICAgICAgICAgICAgICAgICAgZHJvcF9kYXRhO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChteV9kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbXlfZGF0YS5lbmFibGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAkc2VsZlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignZGlzYWJsZWQnLCB0cnVlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZGF0YSgnenNfZGF0YScsIG15X2RhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRyb3BfZGF0YSA9IG15X2RhdGEuJGRyb3BfaXRlbS5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZHJvcF9kYXRhLmVuYWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIG15X2RhdGEuJGRyb3BfaXRlbVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3pzLWRyb3AtZGlzYWJsZWQnKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZGF0YSgnenNfZGF0YScsIGRyb3BfZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnRyaWdnZXIoJ2Rpc2FibGVJdGVtQWZ0ZXInLCAkb3B0aW9ucyk7XHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5lbmFibGVJdGVtID0gZnVuY3Rpb24oZXYsIHpzLCBvcHRpb24pIHtcclxuICAgICAgICBpZiAoIW9wdGlvbikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciAkb3B0aW9ucyA9IHRoaXMuJG9wdGlvbnNcclxuICAgICAgICAgICAgLmZpbHRlcihvcHRpb24pXHJcbiAgICAgICAgICAgIC5lYWNoKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyICRzZWxmID0gJCh0aGlzKSxcclxuICAgICAgICAgICAgICAgICAgICBteV9kYXRhID0gJHNlbGYuZGF0YSgnenNfZGF0YScpLFxyXG4gICAgICAgICAgICAgICAgICAgIGRyb3BfZGF0YTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAobXlfZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG15X2RhdGEuZW5hYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAkc2VsZlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQXR0cignZGlzYWJsZWQnLCB0cnVlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZGF0YSgnenNfZGF0YScsIG15X2RhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRyb3BfZGF0YSA9IG15X2RhdGEuJGRyb3BfaXRlbS5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgZHJvcF9kYXRhLmVuYWJsZSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgbXlfZGF0YS4kZHJvcF9pdGVtXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnenMtZHJvcC1kaXNhYmxlZCcpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5kYXRhKCd6c19kYXRhJywgZHJvcF9kYXRhKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICB0aGlzLnRyaWdnZXIoJ2VuYWJsZUl0ZW1BZnRlcicsICRvcHRpb25zKTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gYWRkIHRyaWdnZXJhYmxlIGV2ZW50c1xyXG4gICAgWnMucHJvdG90eXBlLl9hZGRUcmlnZ2VyYWJsZUV2ZW50cyA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciB0aGF0ID0gdGhpcztcclxuXHJcbiAgICAgICAgdGhpcy5fdHJpZ2dlcmFibGVFdmVudHMgPSB7XHJcbiAgICAgICAgICAgIGFkZEl0ZW0gOiB0aGlzLmFkZEl0ZW0sXHJcbiAgICAgICAgICAgIHNldEl0ZW0gOiB0aGlzLnNldEl0ZW0sXHJcbiAgICAgICAgICAgIHNldFByZXYgOiB0aGlzLnNldFByZXYsXHJcbiAgICAgICAgICAgIHNldE5leHQgOiB0aGlzLnNldE5leHQsXHJcbiAgICAgICAgICAgIGRpc2FibGVJdGVtIDogdGhpcy5kaXNhYmxlSXRlbSxcclxuICAgICAgICAgICAgZW5hYmxlSXRlbSAgOiB0aGlzLmVuYWJsZUl0ZW0sXHJcbiAgICAgICAgICAgIG9wZW4gICAgOiB0aGlzLm9wZW4sXHJcbiAgICAgICAgICAgIGNsb3NlICAgOiB0aGlzLmNsb3NlLFxyXG4gICAgICAgICAgICByZWZyZXNoIDogdGhpcy5yZWZyZXNoLFxyXG4gICAgICAgICAgICBlbmFibGUgIDogdGhpcy5lbmFibGUsXHJcbiAgICAgICAgICAgIGRpc2FibGUgOiB0aGlzLmRpc2FibGUsXHJcbiAgICAgICAgICAgIGRlc3Ryb3kgOiB0aGlzLmRlc3Ryb3lcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAkLmVhY2godGhpcy5fdHJpZ2dlcmFibGVFdmVudHMsICQucHJveHkoZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIHZhciBldmVudF9vcHQgPSAnb24nICsgKGV2ZW50WzBdLnRvVXBwZXJDYXNlKCkgKyBldmVudC5zbGljZSgxKSk7XHJcblxyXG4gICAgICAgICAgICAvL3RoaXMuJHNlbGVjdC5vbihldmVudCArICcuenNlbGVjdCcsICQucHJveHkoY2FsbGJhY2ssIHRoaXMpKTtcclxuICAgICAgICAgICAgdGhpcy4kc2VsZWN0Lm9uKGV2ZW50ICsgJy56c2VsZWN0JywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbXlfYXJndW1lbnRzID0gJC5tYWtlQXJyYXkoYXJndW1lbnRzKTtcclxuICAgICAgICAgICAgICAgIGlmIChteV9hcmd1bWVudHNbMV0gJiYgIW15X2FyZ3VtZW50c1sxXS56cykge1xyXG4gICAgICAgICAgICAgICAgICAgIG15X2FyZ3VtZW50cy5zcGxpY2UoMSwgMCwgdGhhdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobXlfYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIG15X2FyZ3VtZW50cy5wdXNoKHRoYXQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGF0Lm9wdGlvbnNbZXZlbnRfb3B0XSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQub3B0aW9uc1tldmVudF9vcHRdLmFwcGx5KHRoYXQsIG15X2FyZ3VtZW50cyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAkLnByb3h5KGNhbGxiYWNrLCB0aGF0KS5hcHBseSh0aGF0LCBteV9hcmd1bWVudHMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LCB0aGlzKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHRyaWdnZXIgZXZlbnRzXHJcbiAgICBacy5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uKGV2KSB7XHJcbiAgICAgICAgaWYgKCFldikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBldmVudF9vcHQgICAgPSAnb24nICsgKGV2WzBdLnRvVXBwZXJDYXNlKCkgKyBldi5zbGljZSgxKSksXHJcbiAgICAgICAgICAgIG15X2FyZ3VtZW50cyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTtcclxuXHJcbiAgICAgICAgbXlfYXJndW1lbnRzLnVuc2hpZnQodGhpcyk7XHJcblxyXG4gICAgICAgIHRoaXMuJHNlbGVjdC50cmlnZ2VyKGV2ICsgJy56c2VsZWN0JywgbXlfYXJndW1lbnRzKTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLl90cmlnZ2VyYWJsZUV2ZW50c1tldl0gJiYgdHlwZW9mIHRoaXMub3B0aW9uc1tldmVudF9vcHRdID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIG15X2FyZ3VtZW50cy51bnNoaWZ0KFxyXG4gICAgICAgICAgICAgICAgJC5FdmVudChldiArICcuenNlbGVjdCcsIHtcclxuICAgICAgICAgICAgICAgICAgICByZWxhdGVkVGFyZ2V0OiB0aGlzLFxyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUYXJnZXQ6IHRoaXMuJHNlbGVjdFxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zW2V2ZW50X29wdF0uYXBwbHkodGhpcy4kc2VsZWN0LCBteV9hcmd1bWVudHMpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLl9ldmVudHNJbml0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHRoYXQgICAgICAgPSB0aGlzLFxyXG4gICAgICAgICAgICBkb2NfZXZlbnRzID0ge307XHJcblxyXG4gICAgICAgIC8vIGFkZCBzZXJ2aWNlIGZ1bmN0aW9ucyB0byB0aGUgc3RhbmRhcmQgZXZlbnRzIG9mIHNlbGVjdFxyXG4gICAgICAgICQuZWFjaCh7XHJcbiAgICAgICAgICAgICdjaGFuZ2UuenNlbGVjdCc6IGZ1bmN0aW9uKGUsICRvcHRpb24sIHNldF9kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoYXQuaXNfY2hhbmdlX2xvY2tlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignc2V0SXRlbScpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgJC5wcm94eShmdW5jdGlvbihldmVudCwgY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgdGhpcy4kc2VsZWN0Lm9uKGV2ZW50LCAkLnByb3h5KGNhbGxiYWNrLCB0aGlzKSk7XHJcbiAgICAgICAgfSwgdGhpcykpO1xyXG5cclxuICAgICAgICAvLyBpbml0IHpzZWxlY3Qgd3JhcHBlciBldmVudHNcclxuICAgICAgICB0aGlzLl9ldmVudHNXcmFwcGVyKCk7XHJcblxyXG4gICAgICAgIC8vIGluaXQgenNlbGVjdCBidXR0b25zIGV2ZW50c1xyXG4gICAgICAgIGlmICgodGhpcy56c19lbGVtZW50cy4kc2VsZWN0X3RleHQgJiYgdGhpcy56c19lbGVtZW50cy4kc2VsZWN0X3RleHQubGVuZ3RoKVxyXG4gICAgICAgICAgICB8fCAodGhpcy56c19lbGVtZW50cy4kc2VsZWN0X2J0biAmJiB0aGlzLnpzX2VsZW1lbnRzLiRzZWxlY3RfYnRuLmxlbmd0aCkpIHtcclxuICAgICAgICAgICAgdGhpcy5fZXZlbnRzQnRuc0luaXQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGRvY3VtZW50IGV2ZW50c1xyXG4gICAgICAgIGlmICghdGhpcy5tdWx0aXBsZSB8fCAodGhpcy5tdWx0aXBsZSAmJiB0aGlzLm9wdGlvbnMubXVsdGlwbGUuZHJvcCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudXRpbGl0aWVzLnRvdWNoX2VuYWJsZSAmJiAkLkZpbmdlcikge1xyXG4gICAgICAgICAgICAgICAgZG9jX2V2ZW50c1sndGFwLnpzZWxlY3QnICsgdGhpcy5zZWxlY3RfaWRdID0gZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhhdC5pc19vcGVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEkKGUudGFyZ2V0KS5jbG9zZXN0KHRoYXQuenNfZWxlbWVudHMuJHdyYXBwZXIpLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ2Nsb3NlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRvY19ldmVudHNbJ21vdXNlZG93bi56c2VsZWN0JyArIHRoaXMuc2VsZWN0X2lkXSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoYXQuaXNfb3Blbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghJChlLnRhcmdldCkuY2xvc2VzdCh0aGF0LnpzX2VsZW1lbnRzLiR3cmFwcGVyKS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdjbG9zZScpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51dGlsaXRpZXMuJGRvY3VtZW50Lm9uKGRvY19ldmVudHMpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLl9ldmVudHNGaWx0ZXJJdGVtcyA9IGZ1bmN0aW9uKGNoYXJhY3Rlcikge1xyXG4gICAgICAgIHZhciBlc2NhcGVkQ2hhcmFjdGVyID0gY2hhcmFjdGVyLnJlcGxhY2UoIC9bXFwtXFxbXFxde30oKSorPy4sXFxcXFxcXiR8I1xcc10vZywgXCJcXFxcJCZcIiApLFxyXG4gICAgICAgICAgICByZWdleCA9IG5ldyBSZWdFeHAoIFwiXlwiICsgZXNjYXBlZENoYXJhY3RlciwgXCJpXCIgKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuJG9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVnZXgudGVzdChcclxuICAgICAgICAgICAgICAgICQudHJpbSgkKHRoaXMpLnRleHQoKSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLl9ldmVudHNXcmFwcGVyID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzLFxyXG4gICAgICAgICAgICB3cmFwcGVyX2V2ZW50cyA9IHtcclxuICAgICAgICAgICAgICAgIGZvY3VzaW46IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhhdC5pbl9mb2N1cykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnpzX2VsZW1lbnRzLiR3cmFwcGVyLmFkZENsYXNzKCd6cy1mb2N1cycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnpzX2VsZW1lbnRzLiR3cmFwcGVyLnBhcmVudCgpLmFkZENsYXNzKCd6cy1mb2N1cycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmluX2ZvY3VzID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgYmx1cjogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuaW5fZm9jdXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC56c19lbGVtZW50cy4kd3JhcHBlci5yZW1vdmVDbGFzcygnenMtZm9jdXMnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC56c19lbGVtZW50cy4kd3JhcHBlci5wYXJlbnQoKS5yZW1vdmVDbGFzcygnenMtZm9jdXMnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5pbl9mb2N1cyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5pc19vcGVuICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICghdGhhdC5tdWx0aXBsZSB8fCAodGhhdC5tdWx0aXBsZSAmJiB0aGF0Lm9wdGlvbnMubXVsdGlwbGUuZHJvcCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignY2xvc2UnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZvY3VzX3ByZXYsIGZvY3VzX3NraXAsIGZvY3VzX3ByZXZfZmlsdGVyLCBmb2N1c19tYXRjaCxcclxuICAgICAgICAgICAgZm9jdXNfZmlsdGVyX3RpbWVyLCBjaGFyYWN0ZXIsIGN1cl9pbmRleDtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gaG90VHlwaW5nKGUpIHtcclxuICAgICAgICAgICAgZm9jdXNfcHJldiA9IGZvY3VzX3ByZXZfZmlsdGVyIHx8IFwiXCI7XHJcbiAgICAgICAgICAgIGNoYXJhY3RlciA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZS5rZXlDb2RlKTtcclxuICAgICAgICAgICAgZm9jdXNfc2tpcCA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGZvY3VzX2ZpbHRlcl90aW1lcik7XHJcblxyXG4gICAgICAgICAgICBpZiAoY2hhcmFjdGVyID09PSBmb2N1c19wcmV2KSB7XHJcbiAgICAgICAgICAgICAgICBmb2N1c19za2lwID0gdHJ1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNoYXJhY3RlciA9IGZvY3VzX3ByZXYgKyBjaGFyYWN0ZXI7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGN1cl9pbmRleCA9IHRoYXQuJG9wdGlvbnMuaW5kZXgodGhhdC5jdXJyZW50LiRvcHRpb24pO1xyXG4gICAgICAgICAgICBmb2N1c19tYXRjaCA9IHRoYXQuX2V2ZW50c0ZpbHRlckl0ZW1zKGNoYXJhY3Rlcik7XHJcbiAgICAgICAgICAgIGZvY3VzX21hdGNoID0gZm9jdXNfc2tpcCAmJlxyXG4gICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRvcHRpb24gJiZcclxuICAgICAgICAgICAgICAgIGZvY3VzX21hdGNoLmluZGV4KFxyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQuJG9wdGlvbnMuZXEoY3VyX2luZGV4ICsgMSlcclxuICAgICAgICAgICAgICAgICkgIT09IC0xID9cclxuICAgICAgICAgICAgICAgIHRoYXQuJG9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkID4gY3VyX2luZGV4O1xyXG4gICAgICAgICAgICAgICAgfSkgOiBmb2N1c19tYXRjaDtcclxuXHJcbiAgICAgICAgICAgIC8vIElmIG5vIG1hdGNoZXMgb24gdGhlIGN1cnJlbnQgZmlsdGVyLCByZXNldCB0byB0aGUgbGFzdCBjaGFyYWN0ZXIgcHJlc3NlZFxyXG4gICAgICAgICAgICAvLyB0byBtb3ZlIGRvd24gdGhlIG1lbnUgdG8gdGhlIGZpcnN0IGl0ZW0gdGhhdCBzdGFydHMgd2l0aCB0aGF0IGNoYXJhY3RlclxyXG4gICAgICAgICAgICBpZiAoIWZvY3VzX21hdGNoLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgY2hhcmFjdGVyICAgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGUua2V5Q29kZSk7XHJcbiAgICAgICAgICAgICAgICBmb2N1c19tYXRjaCA9IHRoYXQuX2V2ZW50c0ZpbHRlckl0ZW1zKGNoYXJhY3Rlcik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChmb2N1c19tYXRjaC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoYXQuX2ZvY3VzSXRlbShmb2N1c19tYXRjaCk7XHJcbiAgICAgICAgICAgICAgICBmb2N1c19wcmV2X2ZpbHRlciA9IGNoYXJhY3RlcjtcclxuICAgICAgICAgICAgICAgIGZvY3VzX2ZpbHRlcl90aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9jdXNfcHJldl9maWx0ZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH0sIDEwMDApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZm9jdXNfcHJldl9maWx0ZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMudXRpbGl0aWVzLnRvdWNoX2VuYWJsZSAmJiAkLkZpbmdlcikge1xyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhhdC5tdWx0aXBsZSkge1xyXG4gICAgICAgICAgICAgICAgd3JhcHBlcl9ldmVudHMua2V5ZG93biA9IGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcHJldmVudF9kZWZhdWx0ID0gdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJG5ld19vcHRpb24sIGZvY3VzX2luZGV4LCBwb2ludF9pbmRleCwgZmlyc3RfaW5kZXgsIGxhc3RfaW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19vcHRpb25fZGF0YSwgdG1wX2ksICR0bXBfb3B0aW9uLCB0bXBfZGF0YSwgdG1wX21heDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGF0LmlzX2VuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGUua2V5Q29kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHRoYXQudXRpbGl0aWVzLmtleUNvZGUuRU5URVI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoLyohdGhhdC5vcHRpb25zLm5hdGl2ZV9tZW51ICYmICovdGhhdC5pc19vcGVuICYmIHRoYXQub3B0aW9ucy5tdWx0aXBsZS5kcm9wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdjbG9zZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudF9kZWZhdWx0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLkVTQ0FQRTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvKiF0aGF0Lm9wdGlvbnMubmF0aXZlX21lbnUgJiYgKi8hdGhhdC5pc19vcGVuICYmIHRoYXQub3B0aW9ucy5tdWx0aXBsZS5kcm9wKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdjbG9zZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudF9kZWZhdWx0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLkxFRlQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgdGhhdC51dGlsaXRpZXMua2V5Q29kZS5VUDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLmFsdEtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgvKiF0aGF0Lm9wdGlvbnMubmF0aXZlX21lbnUgJiYgKi90aGF0LmlzX29wZW4gJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vcHRpb25zLm11bHRpcGxlLmRyb3AgJiYgZS5rZXlDb2RlICE9PSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLkxFRlQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdjbG9zZScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuY3VycmVudC4kb3B0aW9uID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbmV3X29wdGlvbiAgICAgPSB0aGF0LiRvcHRpb25zLmVxKDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdfb3B0aW9uX2RhdGEgPSAkbmV3X29wdGlvbi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdfb3B0aW9uX2RhdGEgJiYgbmV3X29wdGlvbl9kYXRhLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRvcHRpb25fZm9jdXMgPSAkbmV3X29wdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignc2V0SXRlbScsICRuZXdfb3B0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzX2luZGV4ID0gdGhhdC4kb3B0aW9ucy5pbmRleCh0aGF0LmN1cnJlbnQuJG9wdGlvbl9mb2N1cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50X2luZGV4ID0gdGhhdC4kb3B0aW9ucy5pbmRleCh0aGF0LmN1cnJlbnQuJG9wdGlvbl9wb2ludCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLnNoaWZ0S2V5ICYmICFlLmN0cmxLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c19pbmRleCA8PSBwb2ludF9pbmRleCAmJiBmb2N1c19pbmRleCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NldEl0ZW0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LiRvcHRpb25zLmZpbHRlcihmdW5jdGlvbihpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRzZWxmID0gJCh0aGlzKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhID0gJHNlbGYuZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkID49IGZvY3VzX2luZGV4IC0gMSAmJiBpZCA8PSBwb2ludF9pbmRleCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgJiYgbXlfZGF0YS5lbmFibGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IG11bHRpX3NoaWZ0OiB0cnVlIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzX2luZGV4ID4gcG9pbnRfaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXRJdGVtJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kb3B0aW9ucy5maWx0ZXIoZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSA9ICRzZWxmLmRhdGEoJ3pzX2RhdGEnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgPj0gcG9pbnRfaW5kZXggJiYgaWQgPD0gZm9jdXNfaW5kZXggLSAxICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSAmJiBteV9kYXRhLmVuYWJsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgbXVsdGlfc2hpZnQ6IHRydWUgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuc2hpZnRLZXkgJiYgZS5jdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdF9pbmRleCA9IHRoYXQuJG9wdGlvbnMuaW5kZXgodGhhdC5jdXJyZW50LiRvcHRpb24uZXEoMCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzX2luZGV4IDw9IGZpcnN0X2luZGV4ICYmIGZvY3VzX2luZGV4ICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9pbmRleCA9IHRoYXQuJG9wdGlvbnMuaW5kZXgodGhhdC5jdXJyZW50LiRvcHRpb24uZXEoLTEpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXRJdGVtJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kb3B0aW9ucy5maWx0ZXIoZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSA9ICRzZWxmLmRhdGEoJ3pzX2RhdGEnKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgPj0gZm9jdXNfaW5kZXggLSAxICYmIGlkIDw9IGxhc3RfaW5kZXggJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhICYmIG15X2RhdGEuZW5hYmxlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzX2luZGV4ICE9PSAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKCFlLnNoaWZ0S2V5ICYmICFlLmN0cmxLZXkpIHx8ICghZS5zaGlmdEtleSAmJiBlLmN0cmxLZXkpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRQcmV2Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNfaW5kZXggIT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmN1cnJlbnQuJG9wdGlvbl9mb2N1cyA9IHRoYXQuJG9wdGlvbnMuZXEoZm9jdXNfaW5kZXggLSAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHRoYXQudXRpbGl0aWVzLmtleUNvZGUuUklHSFQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgdGhhdC51dGlsaXRpZXMua2V5Q29kZS5ET1dOOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuYWx0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC8qIXRoYXQub3B0aW9ucy5uYXRpdmVfbWVudSAmJiAqLyF0aGF0LmlzX29wZW4gJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vcHRpb25zLm11bHRpcGxlLmRyb3AgJiYgZS5rZXlDb2RlICE9PSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLlJJR0hUKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignb3BlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuY3VycmVudC4kb3B0aW9uID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkbmV3X29wdGlvbiAgICAgICAgICAgICAgICA9IHRoYXQuJG9wdGlvbnMuZXEoMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld19vcHRpb25fZGF0YSA9ICRuZXdfb3B0aW9uLmRhdGEoJ3pzX2RhdGEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld19vcHRpb25fZGF0YSAmJiBuZXdfb3B0aW9uX2RhdGEuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmN1cnJlbnQuJG9wdGlvbl9mb2N1cyA9ICRuZXdfb3B0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJywgJG5ld19vcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNfaW5kZXggPSB0aGF0LiRvcHRpb25zLmluZGV4KHRoYXQuY3VycmVudC4kb3B0aW9uX2ZvY3VzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRfaW5kZXggPSB0aGF0LiRvcHRpb25zLmluZGV4KHRoYXQuY3VycmVudC4kb3B0aW9uX3BvaW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuc2hpZnRLZXkgJiYgIWUuY3RybEtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzX2luZGV4ID49IHBvaW50X2luZGV4ICYmIGZvY3VzX2luZGV4ICE9PSB0aGF0LiRvcHRpb25zLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXRJdGVtJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kb3B0aW9ucy5maWx0ZXIoZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSA9ICRzZWxmLmRhdGEoJ3pzX2RhdGEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpZCA+PSBwb2ludF9pbmRleCAmJiBpZCA8PSBmb2N1c19pbmRleCArIDEgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhICYmIG15X2RhdGEuZW5hYmxlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBtdWx0aV9zaGlmdDogdHJ1ZSB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c19pbmRleCA8IHBvaW50X2luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2V0SXRlbScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJG9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJHNlbGYgPSAkKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgPSAkc2VsZi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgPj0gZm9jdXNfaW5kZXggKyAxICYmIGlkIDw9IHBvaW50X2luZGV4ICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSAmJiBteV9kYXRhLmVuYWJsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgbXVsdGlfc2hpZnQ6IHRydWUgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuc2hpZnRLZXkgJiYgZS5jdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X2luZGV4ID0gdGhhdC4kb3B0aW9ucy5pbmRleCh0aGF0LmN1cnJlbnQuJG9wdGlvbi5lcSgtMSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzX2luZGV4ID49IGxhc3RfaW5kZXggJiYgZm9jdXNfaW5kZXggIT09IHRoYXQuJG9wdGlvbnMubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2luZGV4ID0gdGhhdC4kb3B0aW9ucy5pbmRleCh0aGF0LmN1cnJlbnQuJG9wdGlvbi5lcSgwKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2V0SXRlbScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJG9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJHNlbGYgPSAkKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgPSAkc2VsZi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgPj0gZmlyc3RfaW5kZXggJiYgaWQgPD0gZm9jdXNfaW5kZXggKyAxICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSAmJiBteV9kYXRhLmVuYWJsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c19pbmRleCAhPT0gdGhhdC4kb3B0aW9ucy5sZW5ndGggLSAxICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKCFlLnNoaWZ0S2V5ICYmICFlLmN0cmxLZXkpIHx8ICghZS5zaGlmdEtleSAmJiBlLmN0cmxLZXkpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXROZXh0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNfaW5kZXggIT09IHRoYXQuJG9wdGlvbnMubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY3VycmVudC4kb3B0aW9uX2ZvY3VzID0gdGhhdC4kb3B0aW9ucy5lcShmb2N1c19pbmRleCArIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgdGhhdC51dGlsaXRpZXMua2V5Q29kZS5IT01FOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHRoYXQudXRpbGl0aWVzLmtleUNvZGUuUEFHRV9VUDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodG1wX2kgPSAwOyB0bXBfaSA8IHRoYXQuJG9wdGlvbnMubGVuZ3RoIC0gMTsgdG1wX2krKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0bXBfb3B0aW9uID0gdGhhdC4kb3B0aW9ucy5lcSh0bXBfaSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wX2RhdGEgICAgPSAkdG1wX29wdGlvbi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRtcF9kYXRhICYmIHRtcF9kYXRhLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldEl0ZW0nLCAkdG1wX29wdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY3VycmVudC4kb3B0aW9uX2ZvY3VzID0gJHRtcF9vcHRpb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHRoYXQudXRpbGl0aWVzLmtleUNvZGUuRU5EOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHRoYXQudXRpbGl0aWVzLmtleUNvZGUuUEFHRV9ET1dOOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh0bXBfbWF4ID0gdGhhdC4kb3B0aW9ucy5sZW5ndGg7IHRtcF9tYXgtLTspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdG1wX29wdGlvbiA9IHRoYXQuJG9wdGlvbnMuZXEodG1wX21heCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wX2RhdGEgPSAkdG1wX29wdGlvbi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRtcF9kYXRhICYmIHRtcF9kYXRhLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldEl0ZW0nLCAkdG1wX29wdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY3VycmVudC4kb3B0aW9uX2ZvY3VzID0gJHRtcF9vcHRpb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0IDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnRfZGVmYXVsdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGF0Lm9wdGlvbnMubmF0aXZlX21lbnUgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoIXRoYXQub3B0aW9ucy5tdWx0aXBsZS5kcm9wIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGF0Lm9wdGlvbnMubXVsdGlwbGUuZHJvcCAmJiB0aGF0LmlzX29wZW4pKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvdFR5cGluZyhlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcmV2ZW50X2RlZmF1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB3cmFwcGVyX2V2ZW50cy5rZXlkb3duID0gZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50X2RlZmF1bHQgPSB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bXBfaSwgJHRtcF9vcHRpb24sIHRtcF9kYXRhLCB0bXBfbWF4O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoYXQuaXNfZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChlLmtleUNvZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLkVOVEVSOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGF0Lm9wdGlvbnMubmF0aXZlX21lbnUgJiYgdGhhdC5pc19vcGVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuZm9jdXNfaXRlbXMuJG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJywgdGhhdC5mb2N1c19pdGVtcy4kb3B0aW9ucy5lcSgwKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignY2xvc2UnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnRfZGVmYXVsdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgdGhhdC51dGlsaXRpZXMua2V5Q29kZS5FU0NBUEU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoYXQub3B0aW9ucy5uYXRpdmVfbWVudSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignY2xvc2UnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnRfZGVmYXVsdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgdGhhdC51dGlsaXRpZXMua2V5Q29kZS5VUDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLmFsdEtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhhdC5vcHRpb25zLm5hdGl2ZV9tZW51ICYmIHRoYXQuaXNfb3Blbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ2Nsb3NlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5mb2N1c19pdGVtcy4kb3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldEl0ZW0nLCB0aGF0LmZvY3VzX2l0ZW1zLiRvcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0Ll9ibHVyRm9jdXNJdGVtKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignc2V0UHJldicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgdGhhdC51dGlsaXRpZXMua2V5Q29kZS5ET1dOOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuYWx0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGF0Lm9wdGlvbnMubmF0aXZlX21lbnUgJiYgIXRoYXQuaXNfb3Blbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ29wZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LmZvY3VzX2l0ZW1zLiRvcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignc2V0SXRlbScsIHRoYXQuZm9jdXNfaXRlbXMuJG9wdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuX2JsdXJGb2N1c0l0ZW0oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXROZXh0Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLkxFRlQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldFByZXYnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHRoYXQudXRpbGl0aWVzLmtleUNvZGUuUklHSFQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldE5leHQnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHRoYXQudXRpbGl0aWVzLmtleUNvZGUuSE9NRTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLlBBR0VfVVA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHRtcF9pID0gMDsgdG1wX2kgPCB0aGF0LiRvcHRpb25zLmxlbmd0aCAtIDE7IHRtcF9pKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdG1wX29wdGlvbiA9IHRoYXQuJG9wdGlvbnMuZXEodG1wX2kpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9kYXRhICAgID0gJHRtcF9vcHRpb24uZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBfZGF0YSAmJiB0bXBfZGF0YS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJywgJHRtcF9vcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLkVORDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSB0aGF0LnV0aWxpdGllcy5rZXlDb2RlLlBBR0VfRE9XTjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodG1wX21heCA9IHRoYXQuJG9wdGlvbnMubGVuZ3RoOyB0bXBfbWF4LS07KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHRtcF9vcHRpb24gPSB0aGF0LiRvcHRpb25zLmVxKHRtcF9tYXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcF9kYXRhID0gJHRtcF9vcHRpb24uZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBfZGF0YSAmJiB0bXBfZGF0YS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJywgJHRtcF9vcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50X2RlZmF1bHQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LmlzX29wZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBob3RUeXBpbmcoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAocHJldmVudF9kZWZhdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnpzX2VsZW1lbnRzLiR3cmFwcGVyLm9uKHdyYXBwZXJfZXZlbnRzKTtcclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLl9ldmVudHNCdG5zSW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciB0aGF0ICAgICAgICA9IHRoaXMsXHJcbiAgICAgICAgICAgIGJ0bnNfZXZlbnRzID0ge30sXHJcbiAgICAgICAgICAgIHRpbWVvdXRfaWQgID0gZmFsc2U7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnV0aWxpdGllcy50b3VjaF9lbmFibGUgJiYgJC5GaW5nZXIpIHtcclxuICAgICAgICAgICAgYnRuc19ldmVudHNbJ3RhcC56c2VsZWN0J10gPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhhdC5pc19lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAodGltZW91dF9pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0X2lkKTtcclxuICAgICAgICAgICAgICAgICAgICB0aW1lb3V0X2lkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aW1lb3V0X2lkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5pc19vcGVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignY2xvc2UnKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ29wZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCAzMCk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYnRuc19ldmVudHMubW91c2Vkb3duID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoYXQuaXNfZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoYXQuaXNfb3Blbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignY2xvc2UnKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdvcGVuJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy56c19lbGVtZW50cy4kc2VsZWN0X3RleHQgJiZcclxuICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kc2VsZWN0X3RleHQubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHNlbGVjdF90ZXh0Lm9uKGJ0bnNfZXZlbnRzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuenNfZWxlbWVudHMuJHNlbGVjdF9idG4gJiZcclxuICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kc2VsZWN0X2J0bi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kc2VsZWN0X2J0bi5vbihidG5zX2V2ZW50cyk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBacy5wcm90b3R5cGUuX2V2ZW50c0Ryb3BJdGVtID0gZnVuY3Rpb24oJGRyb3BfaXRlbSwgJG9wdGlvbikge1xyXG4gICAgICAgIHZhciB0aGF0ICAgPSB0aGlzLFxyXG4gICAgICAgICAgICBldmVudHMgPSB7fTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZXZlbnRTZXREcm9wSXRlbVNpbmdsZSgpIHtcclxuICAgICAgICAgICAgdmFyIGRyb3BfZGF0YSA9ICRvcHRpb24uZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICBpZiAoIXRoYXQuaXNfZW5hYmxlIHx8ICFkcm9wX2RhdGEgfHwgIWRyb3BfZGF0YS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldEl0ZW0nLCAkb3B0aW9uKTtcclxuICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdjbG9zZScpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMubXVsdGlwbGUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudXRpbGl0aWVzLnRvdWNoX2VuYWJsZSAmJiAkLkZpbmdlcikge1xyXG4gICAgICAgICAgICAgICAgZXZlbnRzWyd0YXAuenNlbGVjdCddID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRyb3BfZGF0YSA9ICRvcHRpb24uZGF0YSgnenNfZGF0YScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBteV9pbmRleDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGF0LmlzX2VuYWJsZSB8fCAhZHJvcF9kYXRhIHx8ICFkcm9wX2RhdGEuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LmN1cnJlbnQuJG9wdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5jdXJyZW50LiRvcHRpb24uaW5kZXgoJG9wdGlvbikgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldEl0ZW0nLCB0aGF0LmN1cnJlbnQuJG9wdGlvbi5hZGQoJG9wdGlvbikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRkcm9wX2l0ZW1fcG9pbnQgPSAkZHJvcF9pdGVtO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRvcHRpb25fcG9pbnQgICAgPSAkb3B0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfaW5kZXggPSB0aGF0LmN1cnJlbnQuJG9wdGlvbi5pbmRleCgkb3B0aW9uKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5jdXJyZW50LiRvcHRpb24ubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi5yZW1vdmVBdHRyKCdzZWxlY3RlZCcpLnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignc2V0SXRlbScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY3VycmVudC4kb3B0aW9uICAgID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRkcm9wX2l0ZW0gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJywgdGhhdC5jdXJyZW50LiRvcHRpb24uZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhID0gJHNlbGYuZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgIT09IG15X2luZGV4ICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhICYmIG15X2RhdGEuZW5hYmxlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldEl0ZW0nLCAkb3B0aW9uKTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBldmVudHMubW91c2V1cCA9IGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZHJvcF9kYXRhID0gJG9wdGlvbi5kYXRhKCd6c19kYXRhJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG15X2luZGV4LCBpdGVtX3BvaW50X2luZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJfZmlyc3RfaW5kZXgsIGN1cl9sYXN0X2luZGV4O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoYXQuaXNfZW5hYmxlIHx8ICFkcm9wX2RhdGEgfHwgIWRyb3BfZGF0YS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRvcHRpb25fZm9jdXMgPSAkb3B0aW9uO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZS5jdHJsS2V5ICYmICFlLnNoaWZ0S2V5ICYmIHRoYXQuY3VycmVudC4kb3B0aW9uICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5jdXJyZW50LiRvcHRpb24uaW5kZXgoJG9wdGlvbikgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoJ3NldEl0ZW0nLCB0aGF0LmN1cnJlbnQuJG9wdGlvbi5hZGQoJG9wdGlvbikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRkcm9wX2l0ZW1fcG9pbnQgPSAkZHJvcF9pdGVtO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRvcHRpb25fcG9pbnQgICAgPSAkb3B0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfaW5kZXggPSB0aGF0LmN1cnJlbnQuJG9wdGlvbi5pbmRleCgkb3B0aW9uKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5jdXJyZW50LiRvcHRpb24ubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJG9wdGlvbi5yZW1vdmVBdHRyKCdzZWxlY3RlZCcpLnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignc2V0SXRlbScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuY3VycmVudC4kb3B0aW9uICAgID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRkcm9wX2l0ZW0gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJywgdGhhdC5jdXJyZW50LiRvcHRpb24uZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhID0gJHNlbGYuZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgIT09IG15X2luZGV4ICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhICYmIG15X2RhdGEuZW5hYmxlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlLnNoaWZ0S2V5ICYmICFlLmN0cmxLZXkgJiYgdGhhdC5jdXJyZW50LiRvcHRpb24gIT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LmN1cnJlbnQuJGRyb3BfaXRlbV9wb2ludCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcignc2V0SXRlbScsICRvcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfaW5kZXggICAgICAgICAgID0gdGhhdC4kb3B0aW9ucy5pbmRleCgkb3B0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1fcG9pbnRfaW5kZXggICA9IHRoYXQuJG9wdGlvbnMuaW5kZXgodGhhdC5jdXJyZW50LiRvcHRpb25fcG9pbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChteV9pbmRleCA8IGl0ZW1fcG9pbnRfaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZXRJdGVtJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kb3B0aW9ucy5maWx0ZXIoZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSA9ICRzZWxmLmRhdGEoJ3pzX2RhdGEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpZCA+PSBteV9pbmRleCAmJiBpZCA8PSBpdGVtX3BvaW50X2luZGV4ICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSAmJiBteV9kYXRhLmVuYWJsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgbXVsdGlfc2hpZnQ6IHRydWUgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobXlfaW5kZXggPiBpdGVtX3BvaW50X2luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2V0SXRlbScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJG9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgJHNlbGYgPSAkKHRoaXMpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgPSAkc2VsZi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgPj0gaXRlbV9wb2ludF9pbmRleCAmJiBpZCA8PSBteV9pbmRleCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgJiYgbXlfZGF0YS5lbmFibGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IG11bHRpX3NoaWZ0OiB0cnVlIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15X2luZGV4ID09PSBpdGVtX3BvaW50X2luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2V0SXRlbScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgbXVsdGlfc2hpZnQ6IHRydWUgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZS5zaGlmdEtleSAmJiBlLmN0cmxLZXkgJiYgdGhhdC5jdXJyZW50LiRvcHRpb24gIT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG15X2luZGV4ID0gdGhhdC4kb3B0aW9ucy5pbmRleCgkb3B0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3VyX2ZpcnN0X2luZGV4ID0gdGhhdC4kb3B0aW9ucy5pbmRleCh0aGF0LmN1cnJlbnQuJG9wdGlvbi5lcSgwKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cl9sYXN0X2luZGV4ICA9IHRoYXQuJG9wdGlvbnMuaW5kZXgodGhhdC5jdXJyZW50LiRvcHRpb24uZXEoLTEpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChteV9pbmRleCA+PSBjdXJfZmlyc3RfaW5kZXggJiYgbXlfaW5kZXggPD0gY3VyX2xhc3RfaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2V0SXRlbScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kb3B0aW9ucy5maWx0ZXIoZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRzZWxmID0gJCh0aGlzKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgPSAkc2VsZi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpZCA+PSBjdXJfZmlyc3RfaW5kZXggJiYgaWQgPD0gY3VyX2xhc3RfaW5kZXggJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgJiYgbXlfZGF0YS5lbmFibGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15X2luZGV4IDwgY3VyX2ZpcnN0X2luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRyaWdnZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NldEl0ZW0nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuJG9wdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhID0gJHNlbGYuZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWQgPj0gbXlfaW5kZXggJiYgaWQgPD0gY3VyX2xhc3RfaW5kZXggJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgJiYgbXlfZGF0YS5lbmFibGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15X2luZGV4ID4gY3VyX2xhc3RfaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2V0SXRlbScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC4kb3B0aW9ucy5maWx0ZXIoZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyICRzZWxmID0gJCh0aGlzKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgPSAkc2VsZi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpZCA+PSBjdXJfZmlyc3RfaW5kZXggJiYgaWQgPD0gbXlfaW5kZXggJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15X2RhdGEgJiYgbXlfZGF0YS5lbmFibGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC50cmlnZ2VyKCdzZXRJdGVtJywgJG9wdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5jdXJyZW50LiRkcm9wX2l0ZW1fcG9pbnQgPSAkZHJvcF9pdGVtO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoYXQuY3VycmVudC4kb3B0aW9uX3BvaW50ICAgID0gJG9wdGlvbjtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy51dGlsaXRpZXMudG91Y2hfZW5hYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoJC5GaW5nZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudHNbJ3RhcC56c2VsZWN0J10gPSBldmVudFNldERyb3BJdGVtU2luZ2xlO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudHMuY2xpY2sgPSBldmVudFNldERyb3BJdGVtU2luZ2xlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZXZlbnRzLm1vdXNldXAgPSBldmVudFNldERyb3BJdGVtU2luZ2xlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAkZHJvcF9pdGVtLm9uKGV2ZW50cyk7XHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5fZ2V0U2VsZWN0VGV4dCA9IGZ1bmN0aW9uKCRvcHRpb24pIHtcclxuICAgICAgICB2YXIgdGV4dCA9ICcnO1xyXG5cclxuICAgICAgICBpZiAodHlwZW9mIHRoaXMub3B0aW9ucy5idWlsZFNlbGVjdFRleHQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgdGV4dCA9IHRoaXMub3B0aW9ucy5idWlsZFNlbGVjdFRleHQoJG9wdGlvbik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubXVsdGlwbGUgJiZcclxuICAgICAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHNlbGVjdF90ZXh0ICYmIHRoaXMuenNfZWxlbWVudHMuJHNlbGVjdF90ZXh0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCRvcHRpb24ubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dCA9ICRvcHRpb24udGV4dCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCRvcHRpb24ubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQgPSAkb3B0aW9uLmxlbmd0aCArICcgSXRlbXMnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCRvcHRpb24ubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRoaXMub3B0aW9ucy5wbGFjZWhvbGRlci5ub19vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGV4dCA9ICRvcHRpb24uZXEoMCkudGV4dCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGV4dDtcclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLl9mb2N1c0l0ZW0gPSBmdW5jdGlvbigkb3B0aW9ucykge1xyXG4gICAgICAgIHZhciB0aGF0ID0gdGhpcyxcclxuICAgICAgICAgICAgJGRyb3BfZm9jdXM7XHJcbiAgICAgICAgaWYgKHRoaXMuZm9jdXNfaXRlbXMuJG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgdGhpcy5mb2N1c19pdGVtcy4kZHJvcF9pdGVtcy5yZW1vdmVDbGFzcygnenMtaXRlbS1mb2N1cycpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgJG9wdGlvbnMuZWFjaChmdW5jdGlvbihpZCkge1xyXG4gICAgICAgICAgICB2YXIgJG9wdGlvbiA9ICQodGhpcyksXHJcbiAgICAgICAgICAgICAgICB6c19kYXRhID0gJG9wdGlvbi5kYXRhKCd6c19kYXRhJyksXHJcbiAgICAgICAgICAgICAgICAkZHJvcF9pdGVtID0genNfZGF0YS4kZHJvcF9pdGVtO1xyXG5cclxuICAgICAgICAgICAgaWYgKGlkID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGF0LmZvY3VzX2l0ZW1zLiRkcm9wX2l0ZW1zID0gJGRyb3BfaXRlbTtcclxuICAgICAgICAgICAgICAgIGlmICh6c19kYXRhLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICRkcm9wX2ZvY3VzID0gJGRyb3BfaXRlbTtcclxuICAgICAgICAgICAgICAgICAgICB0aGF0Ll9zZWxlY3RGb2N1c0Ryb3BJdGVtKCRkcm9wX2l0ZW0sICRvcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhhdC5mb2N1c19pdGVtcy4kZHJvcF9pdGVtcyA9IHRoYXQuZm9jdXNfaXRlbXMuJGRyb3BfaXRlbXMuYWRkKCRkcm9wX2l0ZW0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKCEkZHJvcF9mb2N1cykge1xyXG4gICAgICAgICAgICAgICAgICAgICRkcm9wX2ZvY3VzID0gJGRyb3BfaXRlbTtcclxuICAgICAgICAgICAgICAgICAgICB0aGF0Ll9zZWxlY3RGb2N1c0Ryb3BJdGVtKCRkcm9wX2l0ZW0sICRvcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5mb2N1c19pdGVtcy4kb3B0aW9ucyA9ICRvcHRpb25zLmVxKDApO1xyXG5cclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLl9zZWxlY3RGb2N1c0Ryb3BJdGVtID0gZnVuY3Rpb24oJGRyb3BfaXRlbSwgJG9wdGlvbikge1xyXG4gICAgICAgIHRoaXMuZm9jdXNfaXRlbXMuJG9wdGlvbiA9ICRvcHRpb247XHJcbiAgICAgICAgJGRyb3BfaXRlbS5hZGRDbGFzcygnenMtaXRlbS1mb2N1cycpO1xyXG4gICAgICAgIHRoaXMuenNfZWxlbWVudHMuJGRyb3Auc2Nyb2xsVG9wKFxyXG4gICAgICAgICAgICAkZHJvcF9pdGVtLnBvc2l0aW9uKCkudG9wICsgdGhpcy56c19lbGVtZW50cy4kZHJvcC5zY3JvbGxUb3AoKVxyXG4gICAgICAgICk7XHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5fYmx1ckZvY3VzSXRlbSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZvY3VzX2l0ZW1zLiRvcHRpb25zKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9jdXNfaXRlbXMuJG9wdGlvbnMgPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5mb2N1c19pdGVtcy4kb3B0aW9uICA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmZvY3VzX2l0ZW1zLiRkcm9wX2l0ZW1zLnJlbW92ZUNsYXNzKCd6cy1pdGVtLWZvY3VzJyk7XHJcbiAgICAgICAgICAgIHRoaXMuZm9jdXNfaXRlbXMuJGRyb3BfaXRlbXMgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5zZXRJdGVtID0gZnVuY3Rpb24oZXYsIHpzLCBvcHRpb24sIGRhdGEpIHtcclxuICAgICAgICB2YXIgdGhhdCAgICAgICAgICAgPSB0aGlzLFxyXG4gICAgICAgICAgICBpc19wbGFjZWhvbGRlciA9IGZhbHNlLFxyXG4gICAgICAgICAgICBmYWtlX29wdGlvbiAgICA9IGZhbHNlLFxyXG4gICAgICAgICAgICBub19vcHRpb25zICAgICAgPSBmYWxzZSxcclxuICAgICAgICAgICAgJG15X29wdGlvbiwgbXlfZGF0YSwgbXlfdGV4dDtcclxuXHJcbiAgICAgICAgLy8gY2hlY2sgaWYgZXZlbnQgdHJpZ2dlcmVkIGZyb20gaGVyZVxyXG4gICAgICAgIGlmICh0aGlzLmlzX2NoYW5nZV9sb2NrZWQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgdGhpcy5pc19jaGFuZ2VfbG9ja2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGdldCBuZWVkZWQgb3B0aW9uXHJcbiAgICAgICAgaWYgKG9wdGlvbikge1xyXG4gICAgICAgICAgICAkbXlfb3B0aW9uID0gdGhpcy4kc2VsZWN0LmZpbmQob3B0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdGlvbiAmJiAkbXlfb3B0aW9uLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLiRvcHRpb25zLmZpbHRlcignOnNlbGVjdGVkJylcclxuICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdzZWxlY3RlZCcpXHJcbiAgICAgICAgICAgICAgICAucHJvcCgnc2VsZWN0ZWQnLCBmYWxzZSk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5tdWx0aXBsZSkge1xyXG4gICAgICAgICAgICAgICAgJG15X29wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJG15X29wdGlvbi5lcSgwKS5wcm9wKCdzZWxlY3RlZCcsIHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmlzX2NoYW5nZV9sb2NrZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBpZiAoY2hlY2tfcHJvdG90eXBlICYmIHRoaXMub3JpZ19pZCkge1xyXG4gICAgICAgICAgICAgICAgd2luZG93LiQodGhpcy5vcmlnX2lkKS5zaW11bGF0ZSgnY2hhbmdlJyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLiRzZWxlY3QudHJpZ2dlcignY2hhbmdlJywgWyRteV9vcHRpb25dKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmlzX2NoYW5nZV9sb2NrZWQgPSBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkbXlfb3B0aW9uID0gdGhpcy4kb3B0aW9ucy5maWx0ZXIoJzpzZWxlY3RlZCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gcmVtb3ZlIGFjdGl2ZSBjbGFzcyBmcm9tIGFjdGl2ZSBlbGVtZW50c1xyXG4gICAgICAgIGlmICh0aGlzLnpzX2VsZW1lbnRzLiRkcm9wX2l0ZW1zICYmIHRoaXMuenNfZWxlbWVudHMuJGRyb3BfaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJGRyb3BfaXRlbXMuZmlsdGVyKCcuenMtYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ3pzLWFjdGl2ZScpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCEkbXlfb3B0aW9uLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy4kb3B0aW9uX3BsYWNlaG9sZGVyICYmIHRoaXMuJG9wdGlvbl9wbGFjZWhvbGRlci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICRteV9vcHRpb24gPSB0aGlzLiRvcHRpb25fcGxhY2Vob2xkZXI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBub19vcHRpb25zID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmYWtlX29wdGlvbiA9IHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBzZXQgc2VsZWN0IHRleHRcclxuICAgICAgICBpZiAodGhpcy56c19lbGVtZW50cy4kc2VsZWN0X3RleHQpIHtcclxuICAgICAgICAgICAgbXlfdGV4dCA9IHRoaXMuX2dldFNlbGVjdFRleHQoJG15X29wdGlvbiwgbm9fb3B0aW9ucyk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnpzX2VsZW1lbnRzLiRzZWxlY3RfdGV4dC5odG1sKG15X3RleHQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuenNfZWxlbWVudHMuJHdyYXBwZXIuaGFzQ2xhc3MoJ3pzLXBsYWNlaG9sZGVyLWFjdGl2ZScpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHdyYXBwZXIucmVtb3ZlQ2xhc3MoJ3pzLXBsYWNlaG9sZGVyLWFjdGl2ZScpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFmYWtlX29wdGlvbikge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5tdWx0aXBsZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50LiRvcHRpb24gICAgPSAkbXlfb3B0aW9uO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuenNfZWxlbWVudHMuJGRyb3BfaXRlbXMgJiYgdGhpcy56c19lbGVtZW50cy4kZHJvcF9pdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnQuJGRyb3BfaXRlbSA9ICQoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICRteV9vcHRpb24uZWFjaChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgJHRlbXBfaXRlbTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbXlfZGF0YSA9ICQodGhpcykuZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChteV9kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LnpzX2VsZW1lbnRzLiRkcm9wX2l0ZW1zICYmIHRoYXQuenNfZWxlbWVudHMuJGRyb3BfaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBteV9kYXRhLiRkcm9wX2l0ZW1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3pzLWFjdGl2ZScpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0ZW1wX2l0ZW0gICAgICAgICAgICAgID0gdGhhdC5jdXJyZW50LiRkcm9wX2l0ZW07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmN1cnJlbnQuJGRyb3BfaXRlbSA9ICR0ZW1wX2l0ZW0uYWRkKG15X2RhdGEuJGRyb3BfaXRlbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG15X2RhdGEuaXNfcGxhY2Vob2xkZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX3BsYWNlaG9sZGVyID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKCghZGF0YSB8fCAhZGF0YS5tdWx0aV9zaGlmdCkgJiYgdGhhdC56c19lbGVtZW50cy4kZHJvcF9pdGVtcyAmJiB0aGF0LnpzX2VsZW1lbnRzLiRkcm9wX2l0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudC4kZHJvcF9pdGVtX3BvaW50ID0gdGhhdC5jdXJyZW50LiRkcm9wX2l0ZW0uZXEoLTEpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudC4kb3B0aW9uX3BvaW50ICAgID0gdGhhdC5jdXJyZW50LiRvcHRpb24uZXEoLTEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJG15X29wdGlvbiA9ICRteV9vcHRpb24uZXEoMCk7XHJcbiAgICAgICAgICAgICAgICBteV9kYXRhICAgID0gJG15X29wdGlvbi5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgICAgICAgICBpZiAobXlfZGF0YSAmJiBteV9kYXRhLiRkcm9wX2l0ZW0pIHtcclxuICAgICAgICAgICAgICAgICAgICBteV9kYXRhLiRkcm9wX2l0ZW1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCd6cy1hY3RpdmUnKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnQuJGRyb3BfaXRlbSA9IG15X2RhdGEuJGRyb3BfaXRlbTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChteV9kYXRhICYmIG15X2RhdGEuaXNfcGxhY2Vob2xkZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpc19wbGFjZWhvbGRlciA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnQuJG9wdGlvbiA9ICRteV9vcHRpb247XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlzX3BsYWNlaG9sZGVyICYmICRteV9vcHRpb24ubGVuZ3RoID09PSAxIHx8IGZha2Vfb3B0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHdyYXBwZXIuYWRkQ2xhc3MoJ3pzLXBsYWNlaG9sZGVyLWFjdGl2ZScpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy50cmlnZ2VyKCdzZXRJdGVtQWZ0ZXInKTtcclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLnNldFByZXYgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgY3VycmVudF9pbmRleCA9IHRoaXMuY3VycmVudC4kb3B0aW9uID9cclxuICAgICAgICAgICAgICAgIHRoaXMuJG9wdGlvbnMuaW5kZXgodGhpcy5jdXJyZW50LiRvcHRpb24pIDogMSxcclxuICAgICAgICAgICAgdG1wX21heCwgdG1wX2RhdGEsICR0bXBfb3B0aW9uO1xyXG5cclxuICAgICAgICBpZiAoY3VycmVudF9pbmRleCkge1xyXG4gICAgICAgICAgICB0bXBfbWF4ID0gY3VycmVudF9pbmRleDtcclxuICAgICAgICAgICAgZm9yICg7IHRtcF9tYXgtLTspIHtcclxuICAgICAgICAgICAgICAgICR0bXBfb3B0aW9uID0gdGhpcy4kb3B0aW9ucy5lcSh0bXBfbWF4KTtcclxuICAgICAgICAgICAgICAgIHRtcF9kYXRhID0gJHRtcF9vcHRpb24uZGF0YSgnenNfZGF0YScpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRtcF9kYXRhICYmIHRtcF9kYXRhLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2V0SXRlbScsICR0bXBfb3B0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5tdWx0aXBsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnQuJG9wdGlvbl9mb2N1cyA9ICR0bXBfb3B0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLnNldE5leHQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgY3VycmVudF9pbmRleCA9IHRoaXMuY3VycmVudC4kb3B0aW9uID9cclxuICAgICAgICAgICAgICAgIHRoaXMuJG9wdGlvbnMuaW5kZXgodGhpcy5jdXJyZW50LiRvcHRpb24pIDogLTEsXHJcbiAgICAgICAgICAgIHRtcF9pLCB0bXBfZGF0YSwgJHRtcF9vcHRpb247XHJcblxyXG4gICAgICAgIGlmIChjdXJyZW50X2luZGV4IDwgdGhpcy4kb3B0aW9ucy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgIGZvciAodG1wX2kgPSBjdXJyZW50X2luZGV4OyB0bXBfaSA8IHRoaXMuJG9wdGlvbnMubGVuZ3RoIC0gMTsgdG1wX2krKykge1xyXG4gICAgICAgICAgICAgICAgJHRtcF9vcHRpb24gPSB0aGlzLiRvcHRpb25zLmVxKHRtcF9pICsgMSk7XHJcbiAgICAgICAgICAgICAgICB0bXBfZGF0YSAgICA9ICR0bXBfb3B0aW9uLmRhdGEoJ3pzX2RhdGEnKTtcclxuICAgICAgICAgICAgICAgIGlmICh0bXBfZGF0YSAmJiB0bXBfZGF0YS5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3NldEl0ZW0nLCAkdG1wX29wdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubXVsdGlwbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50LiRvcHRpb25fZm9jdXMgPSAkdG1wX29wdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIFpzLnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNfb3Blbikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YXIgZ2VuX3RvcF93LCBnZW5fdG9wX2QsIGhlaWdodF9kLCBvZmZfcG9zX2Q7XHJcblxyXG4gICAgICAgIHRoaXMuenNfZWxlbWVudHMuJHdyYXBwZXIuYWRkQ2xhc3MoJ3pzLW9wZW4nKTtcclxuXHJcbiAgICAgICAgLy8gY2hlY2sgZHJvcCBtZW51IGZvciBwb3NpdGlvblxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMub3Blbl90b3AgJiYgdGhpcy56c19lbGVtZW50cy4kZHJvcCAmJiB0aGlzLnpzX2VsZW1lbnRzLiRkcm9wLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy51dGlsaXRpZXMuJHdpbmRvd1swXS5pbm5lckhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgZ2VuX3RvcF93ID0gdGhpcy51dGlsaXRpZXMuJHdpbmRvd1swXS5pbm5lckhlaWdodCArIHRoaXMudXRpbGl0aWVzLiR3aW5kb3cuc2Nyb2xsVG9wKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBnZW5fdG9wX3cgPSB0aGlzLnV0aWxpdGllcy4kd2luZG93LmhlaWdodCgpICsgdGhpcy51dGlsaXRpZXMuJHdpbmRvdy5zY3JvbGxUb3AoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBoZWlnaHRfZCAgPSB0aGlzLnpzX2VsZW1lbnRzLiRkcm9wLm91dGVySGVpZ2h0KHRydWUpO1xyXG4gICAgICAgICAgICBvZmZfcG9zX2QgPSB0aGlzLnpzX2VsZW1lbnRzLiRkcm9wLm9mZnNldCgpLnRvcDtcclxuICAgICAgICAgICAgZ2VuX3RvcF9kID0gb2ZmX3Bvc19kICsgaGVpZ2h0X2Q7XHJcbiAgICAgICAgICAgIGlmIChnZW5fdG9wX3cgPCBnZW5fdG9wX2QgJiYgb2ZmX3Bvc19kIC0gaGVpZ2h0X2QgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy56c19lbGVtZW50cy4kd3JhcHBlci5hZGRDbGFzcygnenMtb3Blbi10b3AnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5pc19vcGVuID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgdGhpcy50cmlnZ2VyKCdvcGVuQWZ0ZXInKTtcclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzX29wZW4pIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy56c19lbGVtZW50cy4kd3JhcHBlci5yZW1vdmVDbGFzcygnenMtb3BlbicpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy56c19lbGVtZW50cy4kd3JhcHBlci5oYXNDbGFzcygnenMtb3Blbi10b3AnKSkge1xyXG4gICAgICAgICAgICB0aGlzLnpzX2VsZW1lbnRzLiR3cmFwcGVyLnJlbW92ZUNsYXNzKCd6cy1vcGVuLXRvcCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fYmx1ckZvY3VzSXRlbSgpO1xyXG5cclxuICAgICAgICB0aGlzLmlzX29wZW4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnRyaWdnZXIoJ2Nsb3NlQWZ0ZXInKTtcclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLnJlZnJlc2ggPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB0aGlzLnRyaWdnZXIoJ2Rlc3Ryb3knKTtcclxuICAgICAgICBpZiAodGhpcy5sYXp5X3RpbWVyX2lkICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5sYXp5X3RpbWVyX2lkKTtcclxuICAgICAgICAgICAgdGhpcy5sYXp5X3RpbWVyX2lkID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy4kc2VsZWN0LmRhdGEoJ3pzX2RhdGEnKSkge1xyXG4gICAgICAgICAgICB0aGlzLiRzZWxlY3QuZGF0YSgnenNfZGF0YScsIG5ldyBacyh0aGlzLiRzZWxlY3QsIHRoaXMub3B0aW9ucykpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLmVuYWJsZSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzX2VuYWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaXNfZW5hYmxlID0gdHJ1ZTtcclxuICAgICAgICBpZiAodGhpcy4kc2VsZWN0LmF0dHIoJ2Rpc2FibGVkJykpIHtcclxuICAgICAgICAgICAgdGhpcy4kc2VsZWN0LnJlbW92ZUF0dHIoJ2Rpc2FibGVkJylcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy56c19lbGVtZW50cy4kd3JhcHBlci5yZW1vdmVDbGFzcygnenMtZGlzYWJsZWQnKTtcclxuICAgIH07XHJcblxyXG4gICAgWnMucHJvdG90eXBlLmRpc2FibGUgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXNfZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pc19lbmFibGUgPSBmYWxzZTtcclxuICAgICAgICBpZiAodGhpcy5pc19vcGVuICYmICh0aGlzLm11bHRpcGxlICYmICF0aGlzLm9wdGlvbnMubXVsdGlwbGUuZHJvcCkpIHtcclxuICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdjbG9zZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuJHNlbGVjdC5hdHRyKCdkaXNhYmxlZCcpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuJHNlbGVjdC5hdHRyKCdkaXNhYmxlZCcsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnpzX2VsZW1lbnRzLiR3cmFwcGVyLmFkZENsYXNzKCd6cy1kaXNhYmxlZCcpO1xyXG4gICAgfTtcclxuXHJcbiAgICBacy5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBzZWxlY3RfZGF0YSA9IHRoaXMuJHNlbGVjdC5kYXRhKCd6c19kYXRhJyk7XHJcbiAgICAgICAgaWYgKCFzZWxlY3RfZGF0YSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAkLmVhY2godGhpcy5wbHVnaW5zLCAkLnByb3h5KGZ1bmN0aW9uKGtleSwgcGx1Z2luKSB7XHJcbiAgICAgICAgICAgIGlmIChwbHVnaW4uZGVzdHJveSkge1xyXG4gICAgICAgICAgICAgICAgcGx1Z2luLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHRoaXMpKTtcclxuXHJcbiAgICAgICAgdGhpcy51dGlsaXRpZXMuJGRvY3VtZW50Lm9mZignLnpzZWxlY3QnICsgdGhpcy5zZWxlY3RfaWQpO1xyXG5cclxuICAgICAgICB0aGlzLiRvcHRpb25zLnJlbW92ZURhdGEoJ3pzX2RhdGEnKTtcclxuICAgICAgICB0aGlzLiRzZWxlY3RcclxuICAgICAgICAgICAgLmluc2VydEJlZm9yZSh0aGlzLnpzX2VsZW1lbnRzLiR3cmFwcGVyKVxyXG4gICAgICAgICAgICAub2ZmKCcuenNlbGVjdCcpXHJcbiAgICAgICAgICAgIC5yZW1vdmVEYXRhKCd6c19kYXRhJylcclxuICAgICAgICAgICAgLmF0dHIoJ3RhYmluZGV4JywgdGhpcy56c19lbGVtZW50cy4kd3JhcHBlci5hdHRyKCd0YWJpbmRleCcpKTtcclxuXHJcbiAgICAgICAgdGhpcy56c19lbGVtZW50cy4kd3JhcHBlci5yZW1vdmUoKTtcclxuICAgIH07XHJcblxyXG4gICAgJC5mbi56c2VsZWN0ID0gZnVuY3Rpb24ob3B0aW9ucykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHZhciAkc2VsZiA9ICQodGhpcyk7XHJcbiAgICAgICAgICAgIGlmICghJHNlbGYuaXMoJ3NlbGVjdCcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCEkc2VsZi5kYXRhKCd6c19kYXRhJykpIHtcclxuICAgICAgICAgICAgICAgICRzZWxmLmRhdGEoJ3pzX2RhdGEnLCBuZXcgWnModGhpcywgb3B0aW9ucykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgICQuZm4uenNlbGVjdC5Db25zdHJ1Y3RvciA9IFpzO1xyXG59KShqUXVlcnkpOyJdLCJmaWxlIjoibGliL2pxdWVyeS56c2VsZWN0Lm1pbi5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
